<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>一企一策管理平台原型</title>
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
        <script src="https://unpkg.com/dayjs@1.11.10/plugin/customParseFormat.js"></script>
        <script src="https://unpkg.com/dayjs@1.11.10/plugin/isBetween.js"></script>
        <script src="https://unpkg.com/antd@5.12.5/dist/antd.min.js"></script>
        <script src="https://unpkg.com/@ant-design/icons@5.2.6/dist/index.umd.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/antd@5.12.5/dist/reset.css" />
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

        <style>
            body {
                background-color: #f0f2f5;
            }
            .kanban-board {
                display: flex;
                gap: 16px;
                width: 100%;
                overflow-x: auto;
                padding: 16px;
            }
            .kanban-column {
                flex: 1;
                min-width: 280px;
                background-color: #f4f5f7;
                border-radius: 8px;
                padding: 8px;
                display: flex;
                flex-direction: column;
            }
            .kanban-column-title {
                font-weight: bold;
                padding: 8px;
                margin-bottom: 8px;
            }
            .kanban-cards {
                flex-grow: 1;
                min-height: 400px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .kanban-card .ant-card-body {
                padding: 12px;
            }
            .policy-section {
                background-color: #fff;
                padding: 24px;
                margin-bottom: 24px;
                border-radius: 8px;
            }
            .statistic-card .ant-card-body {
                padding: 20px;
            }
            .contract-detail-card .ant-card-body {
                padding-top: 0;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect, useRef, useMemo } = React;
            const {
                Layout,
                Menu,
                Button,
                Table,
                Space,
                Tag,
                Input,
                Select,
                Modal,
                Form,
                message,
                Popconfirm,
                DatePicker,
                Row,
                Col,
                Card,
                Tabs,
                Tree,
                Timeline,
                Progress,
                Upload,
                Badge,
                Steps,
                Divider,
                Tooltip,
                Empty,
                Typography,
                Segmented,
                Radio,
                Checkbox,
                Statistic,
                List,
                Collapse,
                Descriptions,
                InputNumber,
                Result,
            } = antd;
            const { Search } = Input;
            const { RangePicker } = DatePicker;
            const {
                PlusOutlined,
                EditOutlined,
                DeleteOutlined,
                StopOutlined,
                CheckCircleOutlined,
                FileSearchOutlined,
                SettingOutlined,
                ApartmentOutlined,
                BranchesOutlined,
                BellOutlined,
                LockOutlined,
                UnlockOutlined,
                UploadOutlined,
                SolutionOutlined,
                DownloadOutlined,
                SaveOutlined,
                RiseOutlined,
                FallOutlined,
                WarningOutlined,
                LoadingOutlined,
                CheckCircleFilled,
            } = icons;

            dayjs.extend(dayjs_plugin_customParseFormat);
            dayjs.extend(window.dayjs_plugin_isBetween);

            // --- Mock Data ---
            const MOCK_DB = {
                indicatorTemplates: [
                    {
                        id: 1,
                        name: '年度纳税总额',
                        type: '经济指标',
                        creator: '张三',
                        createTime: '2025-03-15',
                        status: 'enabled',
                        primaryKey: 'TAX_TOTAL_ANNUAL',
                        description: '企业在一个自然年度内缴纳的各项税款总和。',
                    },
                    {
                        id: 2,
                        name: '新增就业岗位',
                        type: '综合贡献指标',
                        creator: '李四',
                        createTime: '2025-03-16',
                        status: 'enabled',
                        primaryKey: 'JOB_NEW_COUNT',
                        description: '企业年度新增员工数量。',
                    },
                    {
                        id: 3,
                        name: '研发投入占比',
                        type: '科技指标',
                        creator: '王五',
                        createTime: '2025-04-01',
                        status: 'enabled',
                        primaryKey: 'RD_INVEST_RATIO',
                        description: '研发投入占营业收入的比例。',
                    },
                    {
                        id: 4,
                        name: '固定资产投资',
                        type: '经济指标',
                        creator: '张三',
                        createTime: '2025-04-10',
                        status: 'disabled',
                        primaryKey: 'FIXED_ASSET_INVEST',
                        description: '用于购建固定资产的投资额。',
                    },
                ],
                projects: [
                    {
                        id: 1,
                        name: 'AI芯片研发及产业化项目',
                        company: '芯智科技有限公司',
                        agreementCount: 2,
                        manager: '王经理',
                        managerPhone: '13812345671',
                        unit: '高新技术产业招商局',
                        signDate: '2025-01-20',
                    },
                    {
                        id: 2,
                        name: '新能源汽车电池生产基地',
                        company: '绿能动力股份有限公司',
                        agreementCount: 1,
                        manager: '刘经理',
                        managerPhone: '13812345672',
                        unit: '重大项目招商办公室',
                        signDate: '2025-02-15',
                    },
                    {
                        id: 3,
                        name: '生物医药CRO平台建设',
                        company: '康泰生物医药',
                        agreementCount: 3,
                        manager: '赵经理',
                        managerPhone: '13812345673',
                        unit: '生命健康产业招商局',
                        signDate: '2025-03-10',
                    },
                ],
                landContracts: [
                    {
                        id: 'TD-2025-001',
                        projectName: 'AI芯片产业园一期用地',
                        location: '高新区A地块',
                        area: '50亩',
                        price: '2500万元',
                        signDate: '2024-12-10',
                    },
                    {
                        id: 'TD-2025-002',
                        projectName: '新能源汽车电池生产基地用地',
                        location: '高新区B地块',
                        area: '100亩',
                        price: '5000万元',
                        signDate: '2025-01-05',
                    },
                    {
                        id: 'TD-2025-003',
                        projectName: 'AI芯片产业园二期预留用地',
                        location: '高新区C地块',
                        area: '80亩',
                        price: '4000万元',
                        signDate: '2025-02-20',
                    },
                ],
                landContractDetails: {
                    'TD-2025-001': {
                        basicInfo: {
                            contractId: '35021320180119GC005',
                            projectName: '新型VCSEL、高端LED芯片等半导体及生产项目',
                            company: '厦门市XX半导体科技有限公司',
                            projectNature: '(未填写)',
                            location: '翔安区高新技术产业基地翔安片区舫山南路与张厝路交叉口东北侧地块',
                            acquisitionMethod: '土地出让',
                            area: '24797.4100 m²',
                            investmentUnit: '招商中心',
                            investmentUnitLeaderName: '邱志伟',
                            investmentUnitLeaderPhone: '13950019580',
                            investmentUnitContactName: '葛松洲',
                            investmentUnitContactPhone: '13806050626',
                            companyLeaderName: '李宗',
                            companyLeaderPhone: '13950090799',
                            companyContactName: '李宗',
                            companyContactPhone: '13950090799',
                        },
                        agreementDetails: {
                            start: {
                                title: '开工时间',
                                agreedDate: '2018-10-19',
                                updateTime: '2024-06-27 09:17:15',
                                isStarted: true,
                                actualDate: '2018-12-29',
                                isCompliant: true,
                                complianceNote: '项目于2018年12月29日取得施工许可证，已具备通用开工条件，已动工建设。',
                                isRectified: null,
                                rectificationNote: null,
                                attachments: [
                                    { uid: 'f1', name: '勘探-施工许可证(2018.12.29).pdf' },
                                    { uid: 'f2', name: '勘探-开工函的盖章文件.jpg' },
                                ],
                            },
                            completion: {
                                title: '竣工时间',
                                agreedDate: '2021-10-19',
                                updateTime: '2024-09-18 09:10:54',
                                isCompleted: true,
                                actualDate: '2025-01-26',
                                isCompliant: false,
                                complianceNote:
                                    '项目已完成建设，并于2024年5月29日组织项目二期五方验收，2024年8月24日组织项目五方验收，待申请联合验收。',
                                isRectified: true,
                                rectificationNote:
                                    '项目中试车间因内部设计及工艺优化升级问题导致竣工备案延期，现已完成方案优化调整，已完成工程量增加。',
                                attachments: [
                                    { uid: 'f3', name: '勘探-建设工程竣工验收意见书.pdf' },
                                    { uid: 'f4', name: '勘探-场内道路已完工1.jpg' },
                                ],
                            },
                            production: {
                                title: '投产时间',
                                agreedDate: '2022-04-19',
                                updateTime: '2024-09-19 09:12:59',
                                isStarted: false,
                                actualDate: '(未填写)',
                                isCompliant: false,
                                complianceNote: '项目已完成建设...计划待完成联合验收相关工作后组织设备搬迁安装调试。',
                                isRectified: true,
                                rectificationNote:
                                    '项目已完成建设...计划待完成联合验收相关工作后组织设备搬迁安装调试。',
                                attachments: [{ uid: 'f5', name: '勘探项目（投产）.docx' }],
                            },
                            investment: {
                                title: '投资强度',
                                agreedValue: '不低于人民币 21650 万元/公顷(土地摘牌)',
                                updateTime: '2024-12-13 16:18:13',
                                actualValue: '项目目前投资强度约16794万元/公顷。',
                                isCompliant: false,
                                complianceNote: '此举未达到约定投资强度。',
                                isRectified: false,
                                rectificationNote: '(未填写)',
                                attachments: [],
                            },
                            output: {
                                title: '产值及收益',
                                agreedValue:
                                    '考核年限: 2025\n说明: 考核年限内，项目投产后在投产后第三年度不得低于人民币 12097万元/公顷(土地摘牌)。',
                                agreedRevenue:
                                    '考核年限: 2025\n说明: 本项目签约纳税标准在投产后第三年度不得低于1000万元/公顷(土地摘牌)。',
                            },
                        },
                    },
                },
                projectDetails: {
                    1: {
                        id: 1,
                        name: 'AI芯片研发及产业化项目',
                        companyType: 'manufacturing',
                        investmentType: '设备投资',
                        plan: '分三期建设',
                        landContractIds: ['TD-2025-001', 'TD-2025-003'],
                        timeline: [{ date: '2025-06-30', event: '完成一期厂房建设', status: '已完成' }],
                        department: '科技处',
                        unit: '高新技术产业招商局',
                        manager: '王经理',
                        content: '项目致力于研发新一代AI训练与推理芯片，打破国外技术垄断，形成完整的产业链。',
                        companies: [
                            {
                                id: '91310000MA1FN12345',
                                name: '芯智科技有限公司',
                                registerDate: '2024-11-10',
                                policyCount: 2,
                            },
                        ],
                        agreements: [
                            {
                                id: 1,
                                name: '项目投资主协议',
                                code: 'XZ-2025-001',
                                signDate: '2025-01-20',
                                memoDate: '2025-01-18',
                                parties: '高新区管委会, 芯智科技有限公司',
                                validityYear: '2030',
                                midtermAssessmentYear: '2025',
                                finalAssessmentYear: '2027',
                                midtermFeedback: [
                                    {
                                        date: '2025-08-15 10:00',
                                        content: '已完成中期目标',
                                        files: [{ uid: 'f-mid-1', name: '中期报告.pdf' }],
                                    },
                                ],
                                finalFeedback: [],
                            },
                            {
                                id: 2,
                                name: '人才引进补充协议',
                                code: 'XZ-2025-001-S1',
                                signDate: '2025-03-05',
                                memoDate: '2025-03-01',
                                parties: '高新区人才办, 芯智科技有限公司',
                                validityYear: '2028',
                            },
                        ],
                        indicators: [
                            {
                                year: '2025',
                                items: [
                                    {
                                        name: '一期投资额',
                                        target: '5000万元',
                                        actual: '5100万元 (已确认)',
                                        status: '已确认',
                                        feedbackHistory: [
                                            {
                                                date: '2025-05-28',
                                                content: '完成投资5100万元',
                                                files: [{ uid: 'f1', name: '银行流水.pdf' }],
                                            },
                                        ],
                                    },
                                ],
                            },
                            {
                                year: '2026',
                                items: [
                                    { name: '年度纳税总额', target: '1000万元', actual: '待反馈', status: '进行中' },
                                    { name: '引进高端人才', target: '10名', actual: '待反馈', status: '进行中' },
                                ],
                            },
                        ],
                        policies: [
                            {
                                key: 'p-1-1',
                                title: '高端人才引进补贴',
                                children: [
                                    {
                                        key: 'p-1-1-0',
                                        title: '2024年度人才补贴',
                                        status: '已兑现',
                                        year: '2024',
                                        enterprise: '芯智科技有限公司',
                                        applyTime: '2024-07-10',
                                        applyAmount: 800000,
                                        approvedAmount: 800000,
                                    },
                                    {
                                        key: 'p-1-1-1',
                                        title: '2025年度人才补贴',
                                        status: '已兑现',
                                        year: '2025',
                                        enterprise: '芯智科技有限公司',
                                        applyTime: '2025-07-10',
                                        applyAmount: 1000000,
                                        approvedAmount: 1000000,
                                    },
                                ],
                            },
                            {
                                key: 'p-1-2',
                                title: '研发设备购置补贴',
                                children: [
                                    {
                                        key: 'p-1-2-1',
                                        title: '2025年度设备补贴',
                                        status: '已申报待审批',
                                        year: '2025',
                                        enterprise: '芯智科技有限公司',
                                        applyTime: '2025-08-01',
                                        applyAmount: 5000000,
                                        approvedAmount: 0,
                                    },
                                    {
                                        key: 'p-1-2-2',
                                        title: '2026年度设备补贴',
                                        status: '待配置',
                                        year: '2026',
                                        enterprise: '芯智科技有限公司',
                                    },
                                ],
                            },
                        ],
                    },
                    2: {
                        id: 2,
                        name: '新能源汽车电池生产基地',
                        companyType: 'manufacturing',
                        investmentType: '土建投资',
                        landContractIds: ['TD-2025-002'],
                        unit: '重大项目招商办公室',
                        manager: '刘经理',
                        companies: [
                            {
                                id: '91440300MA5G3J4K6L',
                                name: '绿能动力股份有限公司',
                                registerDate: '2024-10-01',
                                policyCount: 0,
                            },
                        ],
                        agreements: [
                            {
                                id: 3,
                                name: '生产基地投资协议',
                                code: 'LNDL-2025-001',
                                signDate: '2025-02-15',
                                memoDate: '2025-02-10',
                                parties: '高新区管委会, 绿能动力股份有限公司',
                                validityYear: '2035',
                                midtermAssessmentYear: '2026',
                                finalAssessmentYear: '2028',
                            },
                        ],
                        timeline: [{ date: '2025-12-31', event: '完成一期建设', status: '进行中' }],
                        indicators: [
                            {
                                year: '2025',
                                items: [{ name: '新增就业岗位', target: '200人', actual: '待反馈', status: '进行中' }],
                            },
                            {
                                year: '2026',
                                items: [{ name: '环保评估', target: '通过', actual: '已通过', status: '已确认' }],
                            },
                        ],
                        policies: [],
                    },
                    3: {
                        id: 3,
                        name: '生物医药CRO平台建设',
                        companyType: 'non-manufacturing',
                        plan: '一期建设',
                        timeline: [{ date: '2025-09-01', event: '实验室投入使用', status: '未开始' }],
                        department: '生命健康处',
                        unit: '生命健康产业招商局',
                        manager: '赵经理',
                        content: '建设国际一流的生物医药合同研究组织（CRO）服务平台。',
                        companies: [
                            {
                                id: '91110108MA01L2XF4P',
                                name: '康泰生物医药',
                                registerDate: '2025-01-05',
                                policyCount: 1,
                            },
                        ],
                        agreements: [
                            {
                                id: 4,
                                name: 'CRO平台合作协议',
                                code: 'KT-2025-001',
                                signDate: '2025-03-10',
                                memoDate: '2025-03-08',
                                parties: '高新区管委会, 康泰生物医药',
                                validityYear: '2029',
                                midtermAssessmentYear: '2025',
                                finalAssessmentYear: '2026',
                            },
                        ],
                        indicators: [
                            {
                                year: '2025',
                                items: [
                                    {
                                        name: '完成厂房建设',
                                        target: '完成主体结构封顶',
                                        actual: '待审核',
                                        status: '待审核',
                                        feedbackHistory: [{ date: '2025-08-15', content: '已封顶', files: [] }],
                                    },
                                ],
                            },
                            {
                                year: '2026',
                                items: [
                                    { name: '专利申请数', target: '20项', actual: '待反馈', status: '未开始' },
                                    { name: '产品上市许可', target: '1个', actual: '待修改', status: '待修改提交' },
                                ],
                            },
                        ],
                        policies: [
                            {
                                key: 'p-3-1',
                                title: '科研项目经费支持',
                                enterprise: '康泰生物医药',
                                department: '科技局',
                                children: [
                                    { key: 'p-3-1-1', title: '2026年度经费支持', year: '2026', status: '待配置' },
                                ],
                            },
                        ],
                    },
                },
                kanbanTasks: [
                    {
                        id: 1,
                        indicatorName: '年度纳税总额',
                        projectName: 'AI芯片研发及产业化项目',
                        projectCompany: '芯智科技有限公司',
                        targetCompany: '芯智科技有限公司',
                        dueDate: '2025-12-31',
                        status: '进行中',
                    },
                    {
                        id: 2,
                        indicatorName: '新增就业岗位',
                        projectName: '新能源汽车电池生产基地',
                        projectCompany: '绿能动力股份有限公司',
                        targetCompany: '绿能动力股份有限公司',
                        dueDate: '2025-06-30',
                        status: '进行中',
                    },
                    {
                        id: 3,
                        indicatorName: '完成厂房建设',
                        projectName: '生物医药CRO平台建设',
                        projectCompany: '康泰生物医药',
                        targetCompany: '康泰生物医药',
                        dueDate: '2025-08-31',
                        status: '待审核',
                        targetValue: '完成主体结构封顶',
                        completedValue: '已完成主体结构封顶，并通过初步验收',
                        submittedFiles: [
                            { uid: '1', name: '现场照片.zip', status: 'done', url: '#' },
                            { uid: '2', name: '验收报告初稿.pdf', status: 'done', url: '#' },
                        ],
                        submissionTime: '2025-08-25',
                        auditHistory: [
                            {
                                time: '2025-08-25 10:30',
                                action: '提交反馈',
                                user: '康泰生物医药',
                                content: '已完成主体结构封顶',
                            },
                        ],
                    },
                    {
                        id: 4,
                        indicatorName: '一期投资额',
                        projectName: 'AI芯片研发及产业化项目',
                        projectCompany: '芯智科技有限公司',
                        targetCompany: '芯智科技有限公司',
                        dueDate: '2025-05-30',
                        status: '已确认',
                        targetValue: '完成一期投资5000万元',
                        completedValue: '完成投资5100万元',
                        submittedFiles: [{ uid: '1', name: '银行流水.pdf', status: 'done', url: '#' }],
                        submissionTime: '2025-05-28',
                        auditHistory: [
                            {
                                time: '2025-05-28 14:00',
                                action: '提交反馈',
                                user: '芯智科技',
                                content: '完成投资5100万元',
                            },
                            { time: '2025-05-29 09:00', action: '确认，可入库', user: '管理员', content: '审核通过' },
                        ],
                    },
                    {
                        id: 5,
                        indicatorName: '环保评估',
                        projectName: '新能源汽车电池生产基地',
                        projectCompany: '绿能动力股份有限公司',
                        targetCompany: '绿能动力股份有限公司',
                        dueDate: '2025-04-30',
                        status: '已确认',
                    },
                    {
                        id: 6,
                        indicatorName: '专利申请数',
                        projectName: '生物医药CRO平台建设',
                        projectCompany: '康泰生物医药',
                        targetCompany: '康泰生物医药',
                        dueDate: '2026-12-31',
                        status: '未开始',
                    },
                    {
                        id: 7,
                        indicatorName: '产品上市许可',
                        projectName: '生物医药CRO平台建设',
                        projectCompany: '康泰生物医药',
                        targetCompany: '康泰生物医药',
                        dueDate: '2026-07-20',
                        status: '待修改提交',
                        submissionTime: '2026-07-15',
                        auditHistory: [
                            {
                                time: '2026-07-15 11:00',
                                action: '提交反馈',
                                user: '康泰生物医药',
                                content: '已提交申请材料',
                            },
                            {
                                time: '2026-07-16 10:00',
                                action: '退回，重新修改',
                                user: '管理员',
                                content: '缺少关键临床数据报告，请补充后提交。',
                            },
                        ],
                    },
                ],
                enterpriseIndicators: [
                    {
                        id: 1,
                        name: '年度纳税总额',
                        period: '2025年度',
                        target: '1000万元',
                        current: '350万元',
                        progress: 35,
                        status: '进行中',
                    },
                    {
                        id: 2,
                        name: '引进高端人才',
                        period: '2025年度',
                        target: '10名',
                        current: '4名',
                        progress: 40,
                        status: '进行中',
                    },
                    {
                        id: 3,
                        name: '一期投资额',
                        period: '2025年Q2',
                        target: '5000万元',
                        current: '5100万元',
                        progress: 100,
                        status: '已确认',
                        feedbackHistory: [
                            {
                                date: '2025-05-28',
                                content: '完成投资5100万元',
                                files: [{ uid: 'f1', name: '银行流水.pdf' }],
                            },
                        ],
                    },
                    {
                        id: 4,
                        name: '研发投入占比',
                        period: '2026年度',
                        target: '>5%',
                        current: '待提交',
                        progress: 0,
                        status: '待修改提交',
                    },
                ],
                enterprisePolicies: {
                    unlocked: [{ id: 1, name: '一期投资完成奖励', amount: '50万元财政奖励', status: '待申请' }],
                    locked: [
                        { id: 2, name: '年度纳税大户奖励', condition: '完成“年度纳税总额”指标' },
                        { id: 3, name: '高新技术企业认定补贴', condition: '完成“研发投入占比”指标' },
                    ],
                },
                enterpriseBusinessData: [
                    {
                        id: 0,
                        company: '芯智科技有限公司',
                        year: '2023',
                        status: '已审核',
                        submissionTime: '2024-01-15',
                        revenue: { value: 65000000, files: [{ uid: 'r23', name: '2023营收证明.pdf' }] },
                        tax: { value: 5500000, files: [{ uid: 't23', name: '2023税收证明.pdf' }] },
                        fixedInvestment: { value: 15000000, files: [{ uid: 'fi23', name: '2023固投证明.pdf' }] },
                        outputValue: { value: 90000000, files: [{ uid: 'ov23', name: '2023产值证明.pdf' }] },
                        rdInvestment: { value: 4000000, files: [{ uid: 'rd23', name: '2023研发投入证明.pdf' }] },
                        policyPlans: [],
                        auditComments: '数据核实无误，已归档。',
                    },
                    {
                        id: 1,
                        company: '芯智科技有限公司',
                        year: '2024',
                        status: '已审核',
                        submissionTime: '2025-01-15',
                        revenue: { value: 85000000, files: [{ uid: 'r24', name: '2024营收证明.pdf' }] },
                        tax: { value: 7500000, files: [{ uid: 't24', name: '2024税收证明.pdf' }] },
                        fixedInvestment: { value: 20000000, files: [{ uid: 'fi24', name: '2024固投证明.pdf' }] },
                        outputValue: { value: 120000000, files: [{ uid: 'ov24', name: '2024产值证明.pdf' }] },
                        rdInvestment: { value: 6000000, files: [{ uid: 'rd24', name: '2024研发投入证明.pdf' }] },
                        policyPlans: [{ policyKey: 'p-1-1-1', policyName: '2024年度人才补贴', budget: 800000 }],
                        auditComments: '数据核实无误，已归档。',
                    },
                    {
                        id: 2,
                        company: '芯智科技有限公司',
                        year: '2025',
                        status: '待审核',
                        submissionTime: '2025-08-20',
                        revenue: { value: 100000000, files: [{ uid: 'r25', name: '2025营收预估.pdf' }] },
                        tax: { value: 9000000, files: [{ uid: 't25', name: '2025税收预估.pdf' }] },
                        fixedInvestment: { value: 30000000, files: [{ uid: 'fi25', name: '2025固投计划.pdf' }] },
                        outputValue: { value: 150000000, files: [{ uid: 'ov25', name: '2025产值计划.pdf' }] },
                        rdInvestment: { value: 8000000, files: [{ uid: 'rd25', name: '2025研发投入计划.pdf' }] },
                        policyPlans: [
                            { policyKey: 'p-1-1-1', policyName: '2025年度人才补贴', budget: 1000000 },
                            { policyKey: 'p-1-2-1', policyName: '2025年度设备补贴', budget: 5000000 },
                        ],
                    },
                ],
            };

            // --- Helper to use LocalStorage ---
            const useLocalStorage = (key, initialValue) => {
                const [storedValue, setStoredValue] = useState(() => {
                    try {
                        const item = window.localStorage.getItem(key);
                        return item ? JSON.parse(item) : initialValue;
                    } catch (error) {
                        console.log(error);
                        return initialValue;
                    }
                });

                const setValue = value => {
                    try {
                        const valueToStore = value instanceof Function ? value(storedValue) : value;
                        setStoredValue(valueToStore);
                        window.localStorage.setItem(key, JSON.stringify(valueToStore));
                    } catch (error) {
                        console.log(error);
                    }
                };

                return [storedValue, setValue];
            };

            // --- 1. 协议指标管理 ---
            const IndicatorManagement = () => {
                const [templates, setTemplates] = useLocalStorage('indicatorTemplates', MOCK_DB.indicatorTemplates);
                const [filteredTemplates, setFilteredTemplates] = useState(templates);
                const [isModalVisible, setIsModalVisible] = useState(false);
                const [editingTemplate, setEditingTemplate] = useState(null);
                const [isDetailVisible, setIsDetailVisible] = useState(false);
                const [detailTemplate, setDetailTemplate] = useState(null);
                const [form] = Form.useForm();

                useEffect(() => {
                    setFilteredTemplates(templates);
                }, [templates]);

                const handleSearch = filters => {
                    const { name, type, status } = filters;
                    let data = [...templates];
                    if (name) {
                        data = data.filter(item => item.name.includes(name));
                    }
                    if (type) {
                        data = data.filter(item => item.type === type);
                    }
                    if (status) {
                        data = data.filter(item => item.status === status);
                    }
                    setFilteredTemplates(data);
                };

                const showModal = (template = null) => {
                    setEditingTemplate(template);
                    form.setFieldsValue(template || { name: '', type: null, primaryKey: '', description: '' });
                    setIsModalVisible(true);
                };

                const handleOk = () => {
                    form.validateFields()
                        .then(values => {
                            if (editingTemplate) {
                                setTemplates(
                                    templates.map(t => (t.id === editingTemplate.id ? { ...t, ...values } : t))
                                );
                                message.success('指标模板修改成功');
                            } else {
                                const newTemplate = {
                                    id: Date.now(),
                                    ...values,
                                    creator: '管理员',
                                    createTime: dayjs().format('YYYY-MM-DD'),
                                    status: 'enabled',
                                };
                                setTemplates([newTemplate, ...templates]);
                                message.success('指标模板新建成功');
                            }
                            setIsModalVisible(false);
                            form.resetFields();
                        })
                        .catch(info => {
                            console.log('Validate Failed:', info);
                        });
                };

                const handleCancel = () => {
                    setIsModalVisible(false);
                    form.resetFields();
                };

                const handleDelete = id => {
                    setTemplates(templates.filter(t => t.id !== id));
                    message.success('删除成功');
                };

                const showDeleteConfirm = id => {
                    Modal.confirm({
                        title: '您确定要删除这个指标模板吗?',
                        icon: <WarningOutlined />,
                        content: '此操作不可撤销。',
                        okText: '确认删除',
                        okType: 'danger',
                        cancelText: '取消',
                        onOk() {
                            handleDelete(id);
                        },
                    });
                };

                const handleToggleStatus = id => {
                    setTemplates(
                        templates.map(t => {
                            if (t.id === id) {
                                return { ...t, status: t.status === 'enabled' ? 'disabled' : 'enabled' };
                            }
                            return t;
                        })
                    );
                    message.success('状态切换成功');
                };

                const showDetail = template => {
                    setDetailTemplate(template);
                    setIsDetailVisible(true);
                };

                const columns = [
                    { title: '指标名称', dataIndex: 'name', key: 'name' },
                    { title: '指标类型', dataIndex: 'type', key: 'type' },
                    { title: '创建人', dataIndex: 'creator', key: 'creator' },
                    { title: '创建时间', dataIndex: 'createTime', key: 'createTime' },
                    {
                        title: '状态',
                        dataIndex: 'status',
                        key: 'status',
                        render: status => (
                            <Tag color={status === 'enabled' ? 'green' : 'red'}>
                                {status === 'enabled' ? '启用中' : '已停用'}
                            </Tag>
                        ),
                    },
                    {
                        title: '操作',
                        key: 'action',
                        render: (_, record) => (
                            <Space size="middle">
                                <Button type="link" icon={<EditOutlined />} onClick={() => showModal(record)}>
                                    编辑
                                </Button>
                                <Button
                                    type="link"
                                    icon={record.status === 'enabled' ? <StopOutlined /> : <CheckCircleOutlined />}
                                    onClick={() => handleToggleStatus(record.id)}
                                >
                                    {record.status === 'enabled' ? '停用' : '启用'}
                                </Button>
                                <Button type="link" icon={<FileSearchOutlined />} onClick={() => showDetail(record)}>
                                    详情
                                </Button>
                                <Button
                                    type="link"
                                    danger
                                    icon={<DeleteOutlined />}
                                    onClick={() => showDeleteConfirm(record.id)}
                                >
                                    删除
                                </Button>
                            </Space>
                        ),
                    },
                ];

                const indicatorTypes = ['经济指标', '科技指标', '运营指标', '综合贡献指标'];

                return (
                    <Card title="协议指标管理">
                        <Form layout="inline" onFinish={handleSearch} style={{ marginBottom: 16 }}>
                            <Form.Item name="name">
                                <Input placeholder="指标名称" />
                            </Form.Item>
                            <Form.Item name="type">
                                <Select placeholder="指标类型" allowClear style={{ width: 150 }}>
                                    {indicatorTypes.map(t => (
                                        <Select.Option key={t} value={t}>
                                            {t}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Form.Item>
                            <Form.Item name="status">
                                <Select placeholder="启用状态" allowClear style={{ width: 120 }}>
                                    <Select.Option value="enabled">启用中</Select.Option>
                                    <Select.Option value="disabled">已停用</Select.Option>
                                </Select>
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    搜索
                                </Button>
                            </Form.Item>
                            <Form.Item>
                                <Button
                                    onClick={() => {
                                        setFilteredTemplates(templates);
                                    }}
                                >
                                    重置
                                </Button>
                            </Form.Item>
                            <Form.Item style={{ marginLeft: 'auto' }}>
                                <Button type="primary" icon={<PlusOutlined />} onClick={() => showModal()}>
                                    新建指标模板
                                </Button>
                            </Form.Item>
                        </Form>
                        <Table columns={columns} dataSource={filteredTemplates} rowKey="id" />
                        <Modal
                            title={editingTemplate ? '编辑指标模板' : '新建指标模板'}
                            open={isModalVisible}
                            onOk={handleOk}
                            onCancel={handleCancel}
                        >
                            <Form form={form} layout="vertical">
                                <Form.Item
                                    name="name"
                                    label="指标名称"
                                    rules={[{ required: true, message: '请输入指标名称' }]}
                                >
                                    <Input />
                                </Form.Item>
                                <Form.Item
                                    name="type"
                                    label="指标类型"
                                    rules={[{ required: true, message: '请选择指标类型' }]}
                                >
                                    <Select placeholder="请选择">
                                        {indicatorTypes.map(t => (
                                            <Select.Option key={t} value={t}>
                                                {t}
                                            </Select.Option>
                                        ))}
                                    </Select>
                                </Form.Item>
                                <Form.Item
                                    name="primaryKey"
                                    label="关联指标主键"
                                    rules={[{ required: true, message: '请输入关联指标主键' }]}
                                >
                                    <Input placeholder="例如：TAX_TOTAL_ANNUAL" />
                                </Form.Item>
                                <Form.Item name="description" label="模板说明">
                                    <Input.TextArea rows={4} />
                                </Form.Item>
                            </Form>
                        </Modal>
                        <Modal
                            title="指标模板详情"
                            open={isDetailVisible}
                            onCancel={() => setIsDetailVisible(false)}
                            footer={[
                                <Button key="back" onClick={() => setIsDetailVisible(false)}>
                                    返回
                                </Button>,
                            ]}
                        >
                            {detailTemplate && (
                                <div>
                                    <p>
                                        <strong>指标名称:</strong> {detailTemplate.name}
                                    </p>
                                    <p>
                                        <strong>指标类型:</strong> {detailTemplate.type}
                                    </p>
                                    <p>
                                        <strong>关联指标主键:</strong> {detailTemplate.primaryKey}
                                    </p>
                                    <p>
                                        <strong>模板说明:</strong> {detailTemplate.description}
                                    </p>
                                    <Divider />
                                    <Space>
                                        <Button>拆解指标预览</Button>
                                        <Button>反馈指标预览</Button>
                                    </Space>
                                </div>
                            )}
                        </Modal>
                    </Card>
                );
            };

            // --- 2. 项目管理 ---
            const ProjectEntry = ({ project, onBack, onSave, companyType }) => {
                const [entryForm] = Form.useForm();
                const landContracts = MOCK_DB.landContracts;

                useEffect(() => {
                    if (project) {
                        const parsedProject = {
                            ...project,
                            useLand: project.landContractIds && project.landContractIds.length > 0,
                            companies: project.companies?.map(c => ({
                                ...c,
                                registerDate: c.registerDate ? dayjs(c.registerDate) : null,
                            })),
                            agreements: project.agreements?.map(a => ({
                                ...a,
                                signDate: a.signDate ? dayjs(a.signDate) : null,
                                memoDate: a.memoDate ? dayjs(a.memoDate) : null,
                                validityYear: a.validityYear ? dayjs(a.validityYear, 'YYYY') : null,
                                midtermAssessmentYear: a.midtermAssessmentYear
                                    ? dayjs(a.midtermAssessmentYear, 'YYYY')
                                    : null,
                                finalAssessmentYear: a.finalAssessmentYear
                                    ? dayjs(a.finalAssessmentYear, 'YYYY')
                                    : null,
                            })),
                        };
                        entryForm.setFieldsValue(parsedProject);
                    } else {
                        entryForm.resetFields();
                    }
                }, [project, entryForm]);

                const handleSave = () => {
                    entryForm
                        .validateFields()
                        .then(values => {
                            const processedValues = {
                                ...values,
                                agreements: values.agreements?.map(a => ({
                                    ...a,
                                    validityYear: a.validityYear ? dayjs(a.validityYear).format('YYYY') : null,
                                    midtermAssessmentYear: a.midtermAssessmentYear
                                        ? dayjs(a.midtermAssessmentYear).format('YYYY')
                                        : null,
                                    finalAssessmentYear: a.finalAssessmentYear
                                        ? dayjs(a.finalAssessmentYear).format('YYYY')
                                        : null,
                                })),
                            };
                            message.success('项目保存成功！');
                            onSave(processedValues);
                        })
                        .catch(info => {
                            console.log('Validate Failed:', info);
                            message.error('请填写所有必填项！');
                        });
                };

                return (
                    <Card>
                        <div
                            style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: 24,
                            }}
                        >
                            <Space>
                                <Button onClick={onBack}>返回列表</Button>
                                <Typography.Title level={4} style={{ margin: 0 }}>
                                    {project ? '修改项目' : '项目录入'}
                                </Typography.Title>
                            </Space>
                            <div>
                                <Button type="primary" onClick={handleSave} style={{ marginRight: 8 }}>
                                    保存
                                </Button>
                                <Button onClick={onBack}>取消</Button>
                            </div>
                        </div>

                        <Form form={entryForm} layout="vertical">
                            <Divider orientation="left">项目信息</Divider>
                            <Row gutter={16}>
                                <Col span={12}>
                                    <Form.Item name="name" label="项目名称" rules={[{ required: true }]}>
                                        <Input />
                                    </Form.Item>
                                </Col>
                                {(project?.companyType === 'manufacturing' || companyType === 'manufacturing') && (
                                    <Col span={12}>
                                        <Form.Item
                                            name="investmentType"
                                            label="投资类型"
                                            rules={[{ required: true, message: '请选择投资类型' }]}
                                        >
                                            <Select placeholder="请选择投资类型">
                                                <Select.Option value="土建投资">土建投资</Select.Option>
                                                <Select.Option value="设备投资">设备投资</Select.Option>
                                            </Select>
                                        </Form.Item>
                                    </Col>
                                )}
                                <Col span={12}>
                                    <Form.Item name="plan" label="项目规划" rules={[{ required: true }]}>
                                        <Select>
                                            <Select.Option value="分三期建设">分三期建设</Select.Option>
                                        </Select>
                                    </Form.Item>
                                </Col>
                                <Col span={12}>
                                    <Form.Item name="department" label="业务处室" rules={[{ required: true }]}>
                                        <Select>
                                            <Select.Option value="科技处">科技处</Select.Option>
                                        </Select>
                                    </Form.Item>
                                </Col>
                                <Col span={12}>
                                    <Form.Item name="unit" label="招商单位" rules={[{ required: true }]}>
                                        <Select>
                                            <Select.Option value="高新技术产业招商局">高新技术产业招商局</Select.Option>
                                        </Select>
                                    </Form.Item>
                                </Col>
                                <Col span={12}>
                                    <Form.Item name="manager" label="招商经理" rules={[{ required: true }]}>
                                        <Select>
                                            <Select.Option value="王经理">王经理</Select.Option>
                                        </Select>
                                    </Form.Item>
                                </Col>

                                <Col span={24}>
                                    <Form.Item name="useLand" label="是否用地" initialValue={false}>
                                        <Radio.Group>
                                            <Radio value={true}>是</Radio>
                                            <Radio value={false}>否</Radio>
                                        </Radio.Group>
                                    </Form.Item>
                                </Col>

                                <Form.Item
                                    noStyle
                                    shouldUpdate={(prevValues, currentValues) =>
                                        prevValues.useLand !== currentValues.useLand
                                    }
                                >
                                    {({ getFieldValue }) =>
                                        getFieldValue('useLand') === true ? (
                                            <Col span={24}>
                                                <Form.Item
                                                    name="landContractIds"
                                                    label="合同编号"
                                                    rules={[{ required: true, message: '请选择土地出让合同' }]}
                                                >
                                                    <Select
                                                        mode="multiple"
                                                        showSearch
                                                        allowClear
                                                        style={{ width: '100%' }}
                                                        placeholder="请搜索并选择土地出让合同编号"
                                                        optionFilterProp="label"
                                                        options={landContracts.map(c => ({
                                                            value: c.id,
                                                            label: `${c.id} (${c.projectName})`,
                                                        }))}
                                                    />
                                                </Form.Item>
                                            </Col>
                                        ) : null
                                    }
                                </Form.Item>

                                <Col span={24}>
                                    <Form.Item name="content" label="项目内容">
                                        <Input.TextArea rows={4} />
                                    </Form.Item>
                                </Col>
                            </Row>

                            <Divider orientation="left">项目公司</Divider>
                            <Form.List name="companies">
                                {(fields, { add, remove }) => (
                                    <>
                                        {fields.map(({ key, name, ...restField }) => (
                                            <Space
                                                key={key}
                                                style={{ display: 'flex', marginBottom: 8 }}
                                                align="baseline"
                                            >
                                                <Form.Item
                                                    {...restField}
                                                    name={[name, 'name']}
                                                    rules={[{ required: true }]}
                                                >
                                                    <Input placeholder="公司名称" style={{ width: 250 }} />
                                                </Form.Item>
                                                <Form.Item
                                                    {...restField}
                                                    name={[name, 'id']}
                                                    rules={[{ required: true }]}
                                                >
                                                    <Input placeholder="统一社会信用代码" style={{ width: 200 }} />
                                                </Form.Item>
                                                <Form.Item {...restField} name={[name, 'registerDate']}>
                                                    <DatePicker placeholder="注册日期" />
                                                </Form.Item>
                                                <DeleteOutlined onClick={() => remove(name)} />
                                            </Space>
                                        ))}
                                        <Form.Item>
                                            <Button type="dashed" onClick={() => add()} block icon={<PlusOutlined />}>
                                                添加公司
                                            </Button>
                                        </Form.Item>
                                    </>
                                )}
                            </Form.List>

                            <Divider orientation="left">签订的协议</Divider>
                            <Form.List name="agreements">
                                {(fields, { add, remove }) => (
                                    <>
                                        {fields.map(({ key, name, ...restField }, index) => (
                                            <Card
                                                size="small"
                                                key={key}
                                                style={{ marginBottom: 16 }}
                                                title={`协议 ${index + 1}`}
                                                extra={
                                                    <Button
                                                        type="text"
                                                        danger
                                                        icon={<DeleteOutlined />}
                                                        onClick={() => remove(name)}
                                                    />
                                                }
                                            >
                                                <Row gutter={16}>
                                                    <Col span={12}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'name']}
                                                            label="协议名称"
                                                            rules={[{ required: true }]}
                                                        >
                                                            <Input />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={12}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'code']}
                                                            label="协议编号"
                                                            rules={[{ required: true }]}
                                                        >
                                                            <Input />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={8}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'signDate']}
                                                            label="签订日期"
                                                            rules={[{ required: true }]}
                                                        >
                                                            <DatePicker style={{ width: '100%' }} />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={8}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'memoDate']}
                                                            label="纪要日期"
                                                            rules={[{ required: true }]}
                                                        >
                                                            <DatePicker style={{ width: '100%' }} />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={8}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'validityYear']}
                                                            label="协议有效期"
                                                        >
                                                            <DatePicker picker="year" style={{ width: '100%' }} />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={12}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'midtermAssessmentYear']}
                                                            label="期中考核年度"
                                                        >
                                                            <DatePicker picker="year" style={{ width: '100%' }} />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={12}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'finalAssessmentYear']}
                                                            label="期末考核年度"
                                                        >
                                                            <DatePicker picker="year" style={{ width: '100%' }} />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={24}>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'parties']}
                                                            label="协议签约方"
                                                            rules={[{ required: true }]}
                                                        >
                                                            <Input />
                                                        </Form.Item>
                                                    </Col>
                                                </Row>
                                            </Card>
                                        ))}
                                        <Form.Item>
                                            <Button type="dashed" onClick={() => add()} block icon={<PlusOutlined />}>
                                                新增协议
                                            </Button>
                                        </Form.Item>
                                    </>
                                )}
                            </Form.List>
                        </Form>
                    </Card>
                );
            };

            const AnnualKanban = ({
                project,
                showFeedbackModal,
                showAssessmentFeedbackModal,
                showViewFeedbackModal,
            }) => {
                const [businessData] = useLocalStorage('enterpriseBusinessData', MOCK_DB.enterpriseBusinessData);

                const annualData = useMemo(() => {
                    const data = {};
                    const projectCompany = project.companies?.[0]?.name;

                    // Get indicators from project details
                    (project.indicators || []).forEach(yearData => {
                        if (!data[yearData.year]) {
                            data[yearData.year] = { indicators: [], policyPlans: [], assessments: [] };
                        }
                        data[yearData.year].indicators = yearData.items || [];
                    });

                    // Get policy plans from enterprise business data submissions
                    const companyBusinessData = businessData.filter(d => d.company === projectCompany);
                    companyBusinessData.forEach(entry => {
                        if (!data[entry.year]) {
                            data[entry.year] = { indicators: [], policyPlans: [], assessments: [] };
                        }
                        data[entry.year].policyPlans = (data[entry.year].policyPlans || []).concat(
                            entry.policyPlans || []
                        );
                    });

                    // Get assessment tasks from agreements
                    (project.agreements || []).forEach(agreement => {
                        if (agreement.midtermAssessmentYear) {
                            const year = agreement.midtermAssessmentYear;
                            if (!data[year]) {
                                data[year] = { indicators: [], policyPlans: [], assessments: [] };
                            }
                            if (!data[year].assessments) {
                                data[year].assessments = [];
                            }
                            data[year].assessments.push({
                                key: `${agreement.id}-mid`,
                                type: '期中评估',
                                agreementName: agreement.name,
                                status:
                                    agreement.midtermFeedback && agreement.midtermFeedback.length > 0
                                        ? '已反馈'
                                        : '待反馈',
                                agreementId: agreement.id,
                                assessmentType: 'midterm',
                            });
                        }
                        if (agreement.finalAssessmentYear) {
                            const year = agreement.finalAssessmentYear;
                            if (!data[year]) {
                                data[year] = { indicators: [], policyPlans: [], assessments: [] };
                            }
                            if (!data[year].assessments) {
                                data[year].assessments = [];
                            }
                            data[year].assessments.push({
                                key: `${agreement.id}-final`,
                                type: '期末评估',
                                agreementName: agreement.name,
                                status:
                                    agreement.finalFeedback && agreement.finalFeedback.length > 0 ? '已反馈' : '待反馈',
                                agreementId: agreement.id,
                                assessmentType: 'final',
                            });
                        }
                    });

                    return data;
                }, [project, businessData]);

                const availableYears = Object.keys(annualData).sort((a, b) => b - a);

                const [selectedYear, setSelectedYear] = useState(availableYears[0] || dayjs().format('YYYY'));

                useEffect(() => {
                    if (availableYears.length > 0 && !availableYears.includes(selectedYear)) {
                        setSelectedYear(availableYears[0]);
                    }
                }, [availableYears, selectedYear]);

                if (availableYears.length === 0) {
                    return <Empty description="该项目暂无年度计划数据" />;
                }

                const currentData = annualData[selectedYear] || { indicators: [], policyPlans: [], assessments: [] };

                return (
                    <div>
                        <div style={{ marginBottom: 24, display: 'flex', justifyContent: 'center' }}>
                            <Segmented options={availableYears} value={selectedYear} onChange={setSelectedYear} />
                        </div>
                        <Row gutter={16}>
                            <Col span={8}>
                                <Card title={`${selectedYear}年 履约指标`} style={{ height: '100%' }}>
                                    {currentData.indicators.length > 0 ? (
                                        <List
                                            itemLayout="horizontal"
                                            dataSource={currentData.indicators}
                                            renderItem={(item, index) => {
                                                const isFeedbackAllowed = ['进行中', '待修改提交', '待反馈'].includes(
                                                    item.status
                                                );
                                                const hasHistory =
                                                    item.feedbackHistory && item.feedbackHistory.length > 0;
                                                return (
                                                    <List.Item
                                                        actions={
                                                            isFeedbackAllowed
                                                                ? [
                                                                      <Button
                                                                          type="link"
                                                                          onClick={() =>
                                                                              showFeedbackModal(selectedYear, index)
                                                                          }
                                                                      >
                                                                          反馈
                                                                      </Button>,
                                                                  ]
                                                                : hasHistory
                                                                ? [
                                                                      <Button
                                                                          type="link"
                                                                          onClick={() =>
                                                                              showViewFeedbackModal(
                                                                                  item.name,
                                                                                  item.feedbackHistory
                                                                              )
                                                                          }
                                                                      >
                                                                          查看反馈
                                                                      </Button>,
                                                                  ]
                                                                : []
                                                        }
                                                    >
                                                        <List.Item.Meta
                                                            title={item.name}
                                                            description={`约定目标: ${item.target}`}
                                                        />
                                                        <Tag color="blue">{item.status}</Tag>
                                                    </List.Item>
                                                );
                                            }}
                                        />
                                    ) : (
                                        <Empty description="本年度无指标计划" />
                                    )}
                                </Card>
                            </Col>
                            <Col span={8}>
                                <Card title={`${selectedYear}年 政策兑现计划`} style={{ height: '100%' }}>
                                    {currentData.policyPlans.length > 0 ? (
                                        <Table
                                            size="small"
                                            pagination={false}
                                            dataSource={currentData.policyPlans}
                                            rowKey="policyKey"
                                            columns={[
                                                { title: '政策名称', dataIndex: 'policyName', key: 'policyName' },
                                                {
                                                    title: '拟兑现金额(元)',
                                                    dataIndex: 'budget',
                                                    key: 'budget',
                                                    render: val => val?.toLocaleString(),
                                                },
                                            ]}
                                        />
                                    ) : (
                                        <Empty description="本年度无政策兑现计划" />
                                    )}
                                </Card>
                            </Col>
                            <Col span={8}>
                                <Card title={`${selectedYear}年 考核任务`} style={{ height: '100%' }}>
                                    {currentData.assessments.length > 0 ? (
                                        <List
                                            itemLayout="horizontal"
                                            dataSource={currentData.assessments}
                                            renderItem={item => {
                                                const isFeedbackAllowed = item.status === '待反馈';
                                                const agreement = project.agreements.find(
                                                    a => a.id === item.agreementId
                                                );
                                                const history =
                                                    item.assessmentType === 'midterm'
                                                        ? agreement?.midtermFeedback
                                                        : agreement?.finalFeedback;
                                                const hasHistory = history && history.length > 0;

                                                return (
                                                    <List.Item
                                                        actions={
                                                            isFeedbackAllowed
                                                                ? [
                                                                      <Button
                                                                          type="link"
                                                                          onClick={() =>
                                                                              showAssessmentFeedbackModal(
                                                                                  item.agreementId,
                                                                                  item.assessmentType
                                                                              )
                                                                          }
                                                                      >
                                                                          反馈
                                                                      </Button>,
                                                                  ]
                                                                : hasHistory
                                                                ? [
                                                                      <Button
                                                                          type="link"
                                                                          onClick={() =>
                                                                              showViewFeedbackModal(
                                                                                  `${item.agreementName} - ${item.type}`,
                                                                                  history
                                                                              )
                                                                          }
                                                                      >
                                                                          查看反馈
                                                                      </Button>,
                                                                  ]
                                                                : []
                                                        }
                                                    >
                                                        <List.Item.Meta
                                                            title={item.type}
                                                            description={`关联协议: ${item.agreementName}`}
                                                        />
                                                        <Tag color={item.status === '已反馈' ? 'green' : 'orange'}>
                                                            {item.status}
                                                        </Tag>
                                                    </List.Item>
                                                );
                                            }}
                                        />
                                    ) : (
                                        <Empty description="本年度无考核任务" />
                                    )}
                                </Card>
                            </Col>
                        </Row>
                    </div>
                );
            };

            const ProjectDetail = ({ project, setProjectDetails, onBack }) => {
                const [timelineForm] = Form.useForm();
                const [editingNodeIndex, setEditingNodeIndex] = useState(null);
                const [isFeedbackModalVisible, setIsFeedbackModalVisible] = useState(false);
                const [isAssessmentFeedbackModalVisible, setIsAssessmentFeedbackModalVisible] = useState(false);
                const [isViewFeedbackModalVisible, setIsViewFeedbackModalVisible] = useState(false);
                const [feedbackHistory, setFeedbackHistory] = useState({ title: '', history: [] });
                const [currentIndicator, setCurrentIndicator] = useState(null);
                const [currentAgreementFeedback, setCurrentAgreementFeedback] = useState({
                    agreementId: null,
                    type: null,
                });
                const [feedbackForm] = Form.useForm();
                const [assessmentFeedbackForm] = Form.useForm();
                const [policyFilterForm] = Form.useForm();
                const [filteredPolicies, setFilteredPolicies] = useState(project?.policies || []);
                const [expandedAgreementKeys, setExpandedAgreementKeys] = useState([]);
                const landContracts = MOCK_DB.landContracts;
                const landContractDetails = MOCK_DB.landContractDetails;

                useEffect(() => {
                    setFilteredPolicies(project?.policies || []);
                    policyFilterForm.resetFields();
                }, [project]);

                useEffect(() => {
                    if (editingNodeIndex !== null && project?.timeline?.[editingNodeIndex]) {
                        const node = project.timeline[editingNodeIndex];
                        timelineForm.setFieldsValue({
                            ...node,
                            date: dayjs(node.date),
                        });
                    } else {
                        timelineForm.resetFields();
                    }
                }, [editingNodeIndex, project]);

                const handleSaveNode = () => {
                    timelineForm
                        .validateFields()
                        .then(values => {
                            const updatedNode = { ...values, date: values.date.format('YYYY-MM-DD') };
                            const updatedProject = JSON.parse(JSON.stringify(project));

                            if (editingNodeIndex !== null) {
                                updatedProject.timeline[editingNodeIndex] = updatedNode;
                            } else {
                                if (!updatedProject.timeline) {
                                    updatedProject.timeline = [];
                                }
                                updatedProject.timeline.push(updatedNode);
                            }

                            setProjectDetails(prevDetails => ({
                                ...prevDetails,
                                [project.id]: updatedProject,
                            }));

                            message.success(editingNodeIndex !== null ? '节点更新成功' : '节点添加成功');
                            setEditingNodeIndex(null);
                            timelineForm.resetFields();
                        })
                        .catch(info => {
                            console.log('Validate Failed:', info);
                        });
                };

                const showFeedbackModal = (year, itemIndex) => {
                    setCurrentIndicator({ year, itemIndex });
                    feedbackForm.resetFields();
                    setIsFeedbackModalVisible(true);
                };

                const showAssessmentFeedbackModal = (agreementId, type) => {
                    setCurrentAgreementFeedback({ agreementId, type });
                    assessmentFeedbackForm.resetFields();
                    setIsAssessmentFeedbackModalVisible(true);
                };

                const showViewFeedbackModal = (title, history) => {
                    setFeedbackHistory({ title, history: history || [] });
                    setIsViewFeedbackModalVisible(true);
                };

                const handleFeedbackSubmit = () => {
                    feedbackForm.validateFields().then(values => {
                        const { content, files } = values;
                        const updatedProject = JSON.parse(JSON.stringify(project));

                        const yearData = updatedProject.indicators.find(i => i.year === currentIndicator.year);
                        const itemToUpdate = yearData.items[currentIndicator.itemIndex];

                        if (!itemToUpdate.feedbackHistory) {
                            itemToUpdate.feedbackHistory = [];
                        }
                        itemToUpdate.feedbackHistory.push({
                            date: dayjs().format('YYYY-MM-DD HH:mm'),
                            content,
                            files: files?.fileList || [],
                        });
                        itemToUpdate.status = '待审核';
                        itemToUpdate.actual = content;

                        setProjectDetails(prevDetails => ({
                            ...prevDetails,
                            [project.id]: updatedProject,
                        }));

                        message.success('反馈成功');
                        setIsFeedbackModalVisible(false);
                    });
                };

                const handleAssessmentFeedbackSubmit = () => {
                    assessmentFeedbackForm.validateFields().then(values => {
                        const { content, files } = values;
                        const updatedProject = JSON.parse(JSON.stringify(project));

                        const agreementToUpdate = updatedProject.agreements.find(
                            a => a.id === currentAgreementFeedback.agreementId
                        );
                        if (!agreementToUpdate) return;

                        const feedbackKey = `${currentAgreementFeedback.type}Feedback`;
                        if (!agreementToUpdate[feedbackKey]) {
                            agreementToUpdate[feedbackKey] = [];
                        }
                        agreementToUpdate[feedbackKey].push({
                            date: dayjs().format('YYYY-MM-DD HH:mm'),
                            content,
                            files: files?.fileList || [],
                        });

                        const statusKey = `${currentAgreementFeedback.type}Status`;
                        agreementToUpdate[statusKey] = '已反馈';

                        setProjectDetails(prevDetails => ({
                            ...prevDetails,
                            [project.id]: updatedProject,
                        }));

                        message.success('考核反馈成功');
                        setIsAssessmentFeedbackModalVisible(false);
                    });
                };

                const handlePolicyFilter = values => {
                    let originalPolicies = project.policies || [];
                    const { status, enterprise, applyTime, year } = values;

                    if (!status && !enterprise && !applyTime && !year) {
                        setFilteredPolicies(originalPolicies);
                        return;
                    }

                    let filtered = originalPolicies
                        .map(policy => {
                            if (!policy.children || policy.children.length === 0) {
                                return null;
                            }
                            const filteredChildren = policy.children.filter(child => {
                                const statusMatch = !status || child.status === status;
                                const enterpriseMatch = !enterprise || child.enterprise === enterprise;
                                const yearMatch = !year || child.year === year.format('YYYY');

                                let dateMatch = true;
                                if (applyTime && child.applyTime) {
                                    const applyDate = dayjs(child.applyTime);
                                    dateMatch = applyDate.isBetween(applyTime[0], applyTime[1], 'day', '[]');
                                } else if (applyTime && !child.applyTime) {
                                    dateMatch = false;
                                }

                                return statusMatch && enterpriseMatch && yearMatch && dateMatch;
                            });

                            if (filteredChildren.length > 0) {
                                return { ...policy, children: filteredChildren };
                            }
                            return null;
                        })
                        .filter(Boolean);

                    setFilteredPolicies(filtered);
                };

                const getStepStatus = (nodeStatus, index, currentIndex) => {
                    if (index < currentIndex) return 'finish';
                    if (index === currentIndex) return 'process';
                    return 'wait';
                };

                const getStepIcon = nodeStatus => {
                    if (nodeStatus === '已完成') return <CheckCircleFilled />;
                    if (nodeStatus === '进行中') return <LoadingOutlined />;
                    return null;
                };

                const policyStats = filteredPolicies.reduce(
                    (acc, policy) => {
                        (policy.children || []).forEach(child => {
                            acc.count += 1;
                            if (child.applyAmount) acc.apply += child.applyAmount;
                            if (child.approvedAmount) acc.approve += child.approvedAmount;
                        });
                        return acc;
                    },
                    { count: 0, apply: 0, approve: 0 }
                );

                const policyTreeData = filteredPolicies.map(p => ({
                    key: p.key,
                    title: p.title,
                    children: (p.children || []).map(c => ({
                        key: c.key,
                        title: (
                            <div style={{ width: '100%' }}>
                                <b>{c.title}</b>
                                <Descriptions bordered size="small" column={2} style={{ marginTop: 8 }}>
                                    <Descriptions.Item label="兑现年度">{c.year || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="申报企业">{c.enterprise}</Descriptions.Item>
                                    <Descriptions.Item label="申报时间">{c.applyTime || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="申报金额">
                                        {c.applyAmount ? `${c.applyAmount / 10000}万元` : '-'}
                                    </Descriptions.Item>
                                    <Descriptions.Item label="审批金额">
                                        {c.approvedAmount ? `${c.approvedAmount / 10000}万元` : '-'}
                                    </Descriptions.Item>
                                    <Descriptions.Item label="状态">
                                        <Tag
                                            color={
                                                c.status === '待配置'
                                                    ? 'orange'
                                                    : c.status === '已兑现'
                                                    ? 'green'
                                                    : 'cyan'
                                            }
                                        >
                                            {c.status}
                                        </Tag>
                                    </Descriptions.Item>
                                </Descriptions>
                            </div>
                        ),
                    })),
                }));

                const handleAgreementExpand = (expanded, record) => {
                    setExpandedAgreementKeys(
                        expanded
                            ? [...expandedAgreementKeys, record.id]
                            : expandedAgreementKeys.filter(key => key !== record.id)
                    );
                };

                const handleViewFeedbackClick = recordId => {
                    const isExpanded = expandedAgreementKeys.includes(recordId);
                    handleAgreementExpand(!isExpanded, { id: recordId });
                };

                const agreementColumns = [
                    {
                        title: '协议名称',
                        dataIndex: 'name',
                        render: (text, record) => {
                            const currentYear = dayjs().year().toString();
                            const needsWarning =
                                record.midtermAssessmentYear === currentYear ||
                                record.finalAssessmentYear === currentYear;
                            return (
                                <Space>
                                    {text}
                                    {needsWarning && (
                                        <Tooltip title="本年度有考核任务">
                                            <WarningOutlined style={{ color: 'orange' }} />
                                        </Tooltip>
                                    )}
                                </Space>
                            );
                        },
                    },
                    { title: '协议编号', dataIndex: 'code' },
                    { title: '签订日期', dataIndex: 'signDate' },
                    { title: '协议有效期', dataIndex: 'validityYear' },
                    { title: '期中考核年度', dataIndex: 'midtermAssessmentYear' },
                    {
                        title: '期中反馈状态',
                        dataIndex: 'midtermFeedback',
                        render: feedback => {
                            const hasFeedback = feedback && feedback.length > 0;
                            return (
                                <Tag color={hasFeedback ? 'green' : 'default'}>{hasFeedback ? '已反馈' : '待反馈'}</Tag>
                            );
                        },
                    },
                    { title: '期末考核年度', dataIndex: 'finalAssessmentYear' },
                    {
                        title: '期末反馈状态',
                        dataIndex: 'finalFeedback',
                        render: feedback => {
                            const hasFeedback = feedback && feedback.length > 0;
                            return (
                                <Tag color={hasFeedback ? 'green' : 'default'}>{hasFeedback ? '已反馈' : '待反馈'}</Tag>
                            );
                        },
                    },
                    {
                        title: '操作',
                        key: 'action',
                        render: (_, record) => {
                            const hasFeedback =
                                (record.midtermFeedback && record.midtermFeedback.length > 0) ||
                                (record.finalFeedback && record.finalFeedback.length > 0);
                            return (
                                <Space>
                                    {record.midtermAssessmentYear && (
                                        <Button
                                            type="link"
                                            size="small"
                                            onClick={() => showAssessmentFeedbackModal(record.id, 'midterm')}
                                        >
                                            录入期中反馈
                                        </Button>
                                    )}
                                    {record.finalAssessmentYear && (
                                        <Button
                                            type="link"
                                            size="small"
                                            onClick={() => showAssessmentFeedbackModal(record.id, 'final')}
                                        >
                                            录入期末反馈
                                        </Button>
                                    )}
                                    {hasFeedback && (
                                        <Button
                                            type="link"
                                            size="small"
                                            onClick={() => handleViewFeedbackClick(record.id)}
                                        >
                                            {expandedAgreementKeys.includes(record.id) ? '收起反馈' : '查看反馈'}
                                        </Button>
                                    )}
                                </Space>
                            );
                        },
                    },
                ];

                const expandedAgreementRender = record => {
                    return (
                        <div style={{ padding: '8px 16px', backgroundColor: '#fafafa' }}>
                            <Typography.Title level={5}>考核反馈历史</Typography.Title>
                            <Divider style={{ margin: '8px 0' }} />
                            <b>期中考核:</b>
                            {record.midtermFeedback && record.midtermFeedback.length > 0 ? (
                                <Timeline style={{ paddingTop: '10px' }}>
                                    {record.midtermFeedback.map((fb, i) => (
                                        <Timeline.Item key={`mid_${i}`}>
                                            <p>
                                                <strong>{fb.date}</strong>
                                            </p>
                                            <p>{fb.content}</p>
                                            <Upload
                                                fileList={fb.files}
                                                disabled
                                                itemRender={(originNode, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Timeline.Item>
                                    ))}
                                </Timeline>
                            ) : (
                                <p style={{ color: '#888', marginTop: '8px', paddingLeft: '24px' }}>暂无反馈</p>
                            )}
                            <Divider style={{ margin: '8px 0' }} />
                            <b>期末考核:</b>
                            {record.finalFeedback && record.finalFeedback.length > 0 ? (
                                <Timeline style={{ paddingTop: '10px' }}>
                                    {record.finalFeedback.map((fb, i) => (
                                        <Timeline.Item key={`final_${i}`}>
                                            <p>
                                                <strong>{fb.date}</strong>
                                            </p>
                                            <p>{fb.content}</p>
                                            <Upload
                                                fileList={fb.files}
                                                disabled
                                                itemRender={(originNode, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Timeline.Item>
                                    ))}
                                </Timeline>
                            ) : (
                                <p style={{ color: '#888', marginTop: '8px', paddingLeft: '24px' }}>暂无反馈</p>
                            )}
                        </div>
                    );
                };

                const currentStepIndex = project?.timeline?.findIndex(t => t.status === '进行中') ?? 0;

                const renderStatusTag = (value, text) => {
                    if (value === null || value === undefined) return '-';
                    const color = value ? 'success' : 'warning';
                    const statusText = text ? (value ? text[0] : text[1]) : value ? '是' : '否';
                    return <Tag color={color}>{statusText}</Tag>;
                };

                const AgreementDetailSection = ({ data }) => (
                    <Card size="small" title={data.title} style={{ marginBottom: 16 }}>
                        <Descriptions bordered column={1} size="small">
                            <Descriptions.Item label={`约定${data.title.slice(0, 2)}时间`}>
                                {data.agreedDate || data.agreedValue}
                            </Descriptions.Item>
                            {data.updateTime && (
                                <Descriptions.Item label="实际履约情况 (更新时间)">{data.updateTime}</Descriptions.Item>
                            )}

                            {data.hasOwnProperty('isStarted') && (
                                <Descriptions.Item label={`是否${data.title.slice(0, 2)}`}>
                                    {renderStatusTag(data.isStarted)}
                                </Descriptions.Item>
                            )}
                            {data.hasOwnProperty('isCompleted') && (
                                <Descriptions.Item label={`是否${data.title.slice(0, 2)}`}>
                                    {renderStatusTag(data.isCompleted)}
                                </Descriptions.Item>
                            )}

                            {data.actualDate && (
                                <Descriptions.Item label={`实际${data.title.slice(0, 2)}时间`}>
                                    {data.actualDate}
                                </Descriptions.Item>
                            )}
                            {data.actualValue && (
                                <Descriptions.Item label="实际投资强度">{data.actualValue}</Descriptions.Item>
                            )}

                            {data.hasOwnProperty('isCompliant') && (
                                <Descriptions.Item label="是否履约">
                                    {renderStatusTag(data.isCompliant)}
                                </Descriptions.Item>
                            )}
                            {data.complianceNote && (
                                <Descriptions.Item label="履约情况说明">{data.complianceNote}</Descriptions.Item>
                            )}

                            {data.hasOwnProperty('isRectified') && data.isRectified !== null && (
                                <Descriptions.Item label="是否已整改">
                                    {renderStatusTag(data.isRectified)}
                                </Descriptions.Item>
                            )}
                            {data.rectificationNote && (
                                <Descriptions.Item label="整改情况说明">{data.rectificationNote}</Descriptions.Item>
                            )}

                            {data.attachments && data.attachments.length > 0 && (
                                <Descriptions.Item label="附件">
                                    <Upload defaultFileList={data.attachments} disabled>
                                        <Button icon={<DownloadOutlined />}>查看附件</Button>
                                    </Upload>
                                </Descriptions.Item>
                            )}
                            {data.agreedRevenue && (
                                <Descriptions.Item label="约定收益及考核年限">
                                    <pre style={{ fontFamily: 'inherit', margin: 0 }}>{data.agreedRevenue}</pre>
                                </Descriptions.Item>
                            )}
                        </Descriptions>
                    </Card>
                );

                if (!project) {
                    return (
                        <Card>
                            <Button onClick={onBack}>返回列表</Button>
                            <Empty description="未找到项目详情" />
                        </Card>
                    );
                }
                return (
                    <Card>
                        <div
                            style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: 24,
                            }}
                        >
                            <Space align="center">
                                <Button onClick={onBack}>返回列表</Button>
                                <Typography.Title level={4} style={{ margin: 0 }}>
                                    项目详情
                                </Typography.Title>
                            </Space>
                        </div>

                        <Card title="项目基本概况" style={{ marginBottom: 24 }}>
                            <Row gutter={16}>
                                <Col span={8}>
                                    <p>
                                        <strong>项目名称:</strong> {project.name}
                                    </p>
                                </Col>
                                <Col span={8}>
                                    <p>
                                        <strong>项目规划:</strong> {project.plan}
                                    </p>
                                </Col>
                                <Col span={8}>
                                    <p>
                                        <strong>业务处室:</strong> {project.department}
                                    </p>
                                </Col>
                                <Col span={8}>
                                    <p>
                                        <strong>招商单位:</strong> {project.unit}
                                    </p>
                                </Col>
                                <Col span={8}>
                                    <p>
                                        <strong>招商经理:</strong> {project.manager}
                                    </p>
                                </Col>
                            </Row>
                            <Divider />
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <Typography.Title level={5}>项目时间节点</Typography.Title>
                                <Space>
                                    <Button onClick={() => setEditingNodeIndex(null)} icon={<PlusOutlined />}>
                                        添加节点
                                    </Button>
                                    <Button
                                        onClick={() => setEditingNodeIndex(currentStepIndex)}
                                        icon={<EditOutlined />}
                                    >
                                        编辑当前节点
                                    </Button>
                                </Space>
                            </div>
                            <Steps current={currentStepIndex} style={{ marginTop: 24 }}>
                                {(project.timeline || []).map((item, index) => (
                                    <Steps.Step
                                        key={index}
                                        title={item.date}
                                        subTitle={item.status}
                                        description={item.event}
                                        status={getStepStatus(item.status, index, currentStepIndex)}
                                        icon={getStepIcon(item.status)}
                                    />
                                ))}
                            </Steps>
                            {editingNodeIndex !== null && (
                                <Card size="small" style={{ marginTop: 24 }}>
                                    <Form form={timelineForm} layout="vertical">
                                        <Row gutter={16}>
                                            <Col span={8}>
                                                <Form.Item
                                                    name="date"
                                                    label="节点日期"
                                                    rules={[{ required: true, message: '请选择日期' }]}
                                                >
                                                    <DatePicker style={{ width: '100%' }} />
                                                </Form.Item>
                                            </Col>
                                            <Col span={8}>
                                                <Form.Item
                                                    name="event"
                                                    label="需完成事项"
                                                    rules={[{ required: true, message: '请输入需完成事项' }]}
                                                >
                                                    <Input />
                                                </Form.Item>
                                            </Col>
                                            <Col span={8}>
                                                <Form.Item
                                                    name="status"
                                                    label="目前已完成情况"
                                                    rules={[{ required: true, message: '请选择状态' }]}
                                                >
                                                    <Select>
                                                        <Select.Option value="未开始">未开始</Select.Option>
                                                        <Select.Option value="进行中">进行中</Select.Option>
                                                        <Select.Option value="已完成">已完成</Select.Option>
                                                    </Select>
                                                </Form.Item>
                                            </Col>
                                        </Row>
                                        <Button type="primary" onClick={handleSaveNode}>
                                            保存节点
                                        </Button>
                                    </Form>
                                </Card>
                            )}
                        </Card>

                        <Tabs defaultActiveKey="0" animated={false}>
                            <Tabs.TabPane tab="年度看板" key="0">
                                <AnnualKanban
                                    project={project}
                                    showFeedbackModal={showFeedbackModal}
                                    showAssessmentFeedbackModal={showAssessmentFeedbackModal}
                                    showViewFeedbackModal={showViewFeedbackModal}
                                />
                            </Tabs.TabPane>
                            <Tabs.TabPane tab="项目详细信息" key="1">
                                <p>
                                    <strong>项目内容:</strong> {project.content}
                                </p>
                                <Divider>项目公司列表</Divider>
                                <Table
                                    size="small"
                                    pagination={false}
                                    dataSource={project.companies || []}
                                    rowKey="id"
                                    columns={[
                                        { title: '公司名称', dataIndex: 'name' },
                                        { title: '统一社会信用代码', dataIndex: 'id' },
                                        { title: '注册日期', dataIndex: 'registerDate' },
                                        {
                                            title: '兑现政策数',
                                            dataIndex: 'policyCount',
                                            render: text => <Button type="link">{text}</Button>,
                                        },
                                    ]}
                                />
                                <Divider>签订协议列表</Divider>
                                <Table
                                    size="small"
                                    pagination={false}
                                    dataSource={project.agreements || []}
                                    rowKey="id"
                                    columns={agreementColumns}
                                    expandable={{
                                        expandedRowRender: expandedAgreementRender,
                                        expandedRowKeys: expandedAgreementKeys,
                                        onExpand: handleAgreementExpand,
                                    }}
                                />
                            </Tabs.TabPane>
                            <Tabs.TabPane tab="指标计划表" key="2">
                                <Timeline>
                                    {(project.indicators || []).map(ind => (
                                        <Timeline.Item key={ind.year}>
                                            <Typography.Title level={5} style={{ margin: '0 0 12px 0' }}>
                                                {ind.year}年
                                            </Typography.Title>
                                            {(ind.items || []).map((item, itemIndex) => (
                                                <Card
                                                    key={item.name}
                                                    size="small"
                                                    style={{ marginBottom: 16, marginLeft: '24px' }}
                                                    title={
                                                        <div
                                                            style={{
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center',
                                                            }}
                                                        >
                                                            <span>{item.name}</span>
                                                            <Tag color="blue">{item.status}</Tag>
                                                        </div>
                                                    }
                                                >
                                                    <p>
                                                        <b>约定目标：</b>
                                                        {item.target}
                                                    </p>
                                                    <p>
                                                        <b>最新反馈：</b>
                                                        {item.actual}
                                                    </p>
                                                    <Button
                                                        type="primary"
                                                        size="small"
                                                        onClick={() => showFeedbackModal(ind.year, itemIndex)}
                                                    >
                                                        反馈
                                                    </Button>
                                                    {item.feedbackHistory && item.feedbackHistory.length > 0 && (
                                                        <Collapse
                                                            size="small"
                                                            style={{ marginTop: 12 }}
                                                            ghost
                                                            motion={null}
                                                        >
                                                            <Collapse.Panel
                                                                header={`查看反馈历史 (${item.feedbackHistory.length}条)`}
                                                                key="1"
                                                            >
                                                                <Timeline>
                                                                    {item.feedbackHistory.map((fb, fbIndex) => (
                                                                        <Timeline.Item key={fbIndex}>
                                                                            <p>
                                                                                <strong>{fb.date}</strong>
                                                                            </p>
                                                                            <p>{fb.content}</p>
                                                                            <Upload
                                                                                fileList={fb.files}
                                                                                disabled
                                                                                itemRender={() => null}
                                                                            />
                                                                            {fb.files?.map(file => (
                                                                                <a key={file.uid} href="#">
                                                                                    {file.name}
                                                                                </a>
                                                                            ))}
                                                                        </Timeline.Item>
                                                                    ))}
                                                                </Timeline>
                                                            </Collapse.Panel>
                                                        </Collapse>
                                                    )}
                                                </Card>
                                            ))}
                                        </Timeline.Item>
                                    ))}
                                </Timeline>
                            </Tabs.TabPane>
                            <Tabs.TabPane tab="兑现政策树" key="3">
                                <Row gutter={16} style={{ marginBottom: 24 }}>
                                    <Col span={8}>
                                        <Card>
                                            <Statistic title="总兑现政策数" value={policyStats.count} />
                                        </Card>
                                    </Col>
                                    <Col span={8}>
                                        <Card>
                                            <Statistic
                                                title="累计申报金额 (万元)"
                                                value={policyStats.apply / 10000}
                                                precision={2}
                                            />
                                        </Card>
                                    </Col>
                                    <Col span={8}>
                                        <Card>
                                            <Statistic
                                                title="累计审批金额 (万元)"
                                                value={policyStats.approve / 10000}
                                                precision={2}
                                            />
                                        </Card>
                                    </Col>
                                </Row>
                                <Form
                                    form={policyFilterForm}
                                    onFinish={handlePolicyFilter}
                                    layout="inline"
                                    style={{
                                        marginBottom: 24,
                                        background: '#fafafa',
                                        padding: '16px',
                                        borderRadius: 8,
                                    }}
                                >
                                    <Form.Item name="status" label="政策状态">
                                        <Select placeholder="请选择" style={{ width: 150 }} allowClear>
                                            <Select.Option value="已兑现">已兑现</Select.Option>
                                            <Select.Option value="已申报待审批">已申报待审批</Select.Option>
                                            <Select.Option value="待配置">待配置</Select.Option>
                                        </Select>
                                    </Form.Item>
                                    <Form.Item name="enterprise" label="企业名称">
                                        <Select placeholder="请选择" style={{ width: 200 }} allowClear>
                                            {(project.companies || []).map(c => (
                                                <Select.Option key={c.id} value={c.name}>
                                                    {c.name}
                                                </Select.Option>
                                            ))}
                                        </Select>
                                    </Form.Item>
                                    <Form.Item name="applyTime" label="申报时间">
                                        <RangePicker />
                                    </Form.Item>
                                    <Form.Item name="year" label="兑现年度">
                                        <DatePicker picker="year" />
                                    </Form.Item>
                                    <Form.Item>
                                        <Button type="primary" htmlType="submit">
                                            查询
                                        </Button>
                                    </Form.Item>
                                    <Form.Item>
                                        <Button
                                            onClick={() => {
                                                policyFilterForm.resetFields();
                                                setFilteredPolicies(project.policies || []);
                                            }}
                                        >
                                            重置
                                        </Button>
                                    </Form.Item>
                                </Form>
                                <Tree motion={null} showLine defaultExpandAll treeData={policyTreeData} />
                            </Tabs.TabPane>
                            <Tabs.TabPane tab="土地监管" key="4">
                                {project.landContractIds && project.landContractIds.length > 0 ? (
                                    <Collapse accordion motion={null}>
                                        {landContracts
                                            .filter(c => project.landContractIds.includes(c.id))
                                            .map(contract => {
                                                const details = landContractDetails[contract.id];
                                                return (
                                                    <Collapse.Panel
                                                        header={`合同编号: ${contract.id} (${contract.projectName})`}
                                                        key={contract.id}
                                                    >
                                                        {details ? (
                                                            <div>
                                                                <Divider orientation="left" plain>
                                                                    基础信息
                                                                </Divider>
                                                                <Descriptions bordered column={2} size="small">
                                                                    <Descriptions.Item label="土地出让合同号" span={2}>
                                                                        {details.basicInfo.contractId}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="项目名称" span={2}>
                                                                        {details.basicInfo.projectName}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="用地单位">
                                                                        {details.basicInfo.company}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="项目性质">
                                                                        {details.basicInfo.projectNature}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="土地坐落" span={2}>
                                                                        {details.basicInfo.location}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="用地取得方式">
                                                                        {details.basicInfo.acquisitionMethod}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="用地面积(m²)">
                                                                        {details.basicInfo.area}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="招商单位">
                                                                        {details.basicInfo.investmentUnit}
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="招商单位领导">
                                                                        {details.basicInfo.investmentUnitLeaderName} (
                                                                        {details.basicInfo.investmentUnitLeaderPhone})
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="招商单位联系人">
                                                                        {details.basicInfo.investmentUnitContactName} (
                                                                        {details.basicInfo.investmentUnitContactPhone})
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="用地单位领导">
                                                                        {details.basicInfo.companyLeaderName} (
                                                                        {details.basicInfo.companyLeaderPhone})
                                                                    </Descriptions.Item>
                                                                    <Descriptions.Item label="用地单位联系人">
                                                                        {details.basicInfo.companyContactName} (
                                                                        {details.basicInfo.companyContactPhone})
                                                                    </Descriptions.Item>
                                                                </Descriptions>

                                                                <Divider orientation="left" plain>
                                                                    合同约定情况
                                                                </Divider>
                                                                <Card size="small" className="contract-detail-card">
                                                                    {Object.values(details.agreementDetails).map(
                                                                        section => (
                                                                            <AgreementDetailSection
                                                                                key={section.title}
                                                                                data={section}
                                                                            />
                                                                        )
                                                                    )}
                                                                </Card>
                                                            </div>
                                                        ) : (
                                                            <Empty description="暂无详细监管信息" />
                                                        )}
                                                    </Collapse.Panel>
                                                );
                                            })}
                                    </Collapse>
                                ) : (
                                    <Empty description="该项目未关联土地出让合同" />
                                )}
                            </Tabs.TabPane>
                        </Tabs>
                        <Modal
                            title="指标完成情况反馈"
                            open={isFeedbackModalVisible}
                            onOk={handleFeedbackSubmit}
                            onCancel={() => setIsFeedbackModalVisible(false)}
                        >
                            <Form form={feedbackForm} layout="vertical">
                                <Form.Item name="content" label="完成情况说明" rules={[{ required: true }]}>
                                    <Input.TextArea rows={4} />
                                </Form.Item>
                                <Form.Item name="files" label="证明材料">
                                    <Upload beforeUpload={() => false} multiple>
                                        <Button icon={<UploadOutlined />}>上传文件</Button>
                                    </Upload>
                                </Form.Item>
                            </Form>
                        </Modal>
                        <Modal
                            title={`${currentAgreementFeedback.type === 'midterm' ? '期中' : '期末'}考核完成情况反馈`}
                            open={isAssessmentFeedbackModalVisible}
                            onOk={handleAssessmentFeedbackSubmit}
                            onCancel={() => setIsAssessmentFeedbackModalVisible(false)}
                        >
                            <Form form={assessmentFeedbackForm} layout="vertical">
                                <Form.Item name="content" label="完成情况说明" rules={[{ required: true }]}>
                                    <Input.TextArea rows={4} />
                                </Form.Item>
                                <Form.Item name="files" label="证明材料">
                                    <Upload beforeUpload={() => false} multiple>
                                        <Button icon={<UploadOutlined />}>上传文件</Button>
                                    </Upload>
                                </Form.Item>
                            </Form>
                        </Modal>
                        <Modal
                            title={`${feedbackHistory.title} - 反馈历史`}
                            open={isViewFeedbackModalVisible}
                            onCancel={() => setIsViewFeedbackModalVisible(false)}
                            footer={[
                                <Button key="close" onClick={() => setIsViewFeedbackModalVisible(false)}>
                                    关闭
                                </Button>,
                            ]}
                        >
                            <Timeline>
                                {feedbackHistory.history.length > 0 ? (
                                    feedbackHistory.history.map((fb, index) => (
                                        <Timeline.Item key={index}>
                                            <p>
                                                <strong>{fb.date || fb.time}</strong>
                                            </p>
                                            <p>{fb.content}</p>
                                            {fb.files && (
                                                <Upload
                                                    fileList={fb.files}
                                                    disabled
                                                    itemRender={(originNode, file) => <a href="#">{file.name}</a>}
                                                />
                                            )}
                                        </Timeline.Item>
                                    ))
                                ) : (
                                    <Empty description="暂无反馈历史" />
                                )}
                            </Timeline>
                        </Modal>
                    </Card>
                );
            };
            const IndicatorBreakdown = ({ project, onBack, onSave }) => {
                const [breakdownPlan, setBreakdownPlan] = useState([]);
                const [isModalVisible, setIsModalVisible] = useState(false);
                const [editingIndicator, setEditingIndicator] = useState(null);
                const [currentYear, setCurrentYear] = useState(null);
                const [form] = Form.useForm();
                const [templates] = useLocalStorage('indicatorTemplates', MOCK_DB.indicatorTemplates);
                const [selectedIndicatorTemplate, setSelectedIndicatorTemplate] = useState(null);
                const [isAddYearModalVisible, setIsAddYearModalVisible] = useState(false);
                const [addYearForm] = Form.useForm();

                useEffect(() => {
                    const initialPlan = (project.indicators || []).map(yearData => ({
                        ...yearData,
                        items: yearData.items.map((item, index) => ({
                            ...item,
                            id: `${yearData.year}-${index}`,
                            agreementId: project.agreements?.[0]?.id,
                            companyId: project.companies?.[0]?.id,
                        })),
                    }));
                    setBreakdownPlan(initialPlan);
                }, [project]);

                const showAddIndicatorModal = year => {
                    setCurrentYear(year);
                    setEditingIndicator(null);
                    form.setFieldsValue({
                        year: dayjs(year, 'YYYY'),
                        agreementId: null,
                        companyId: null,
                        indicatorTemplateId: null,
                        targetValue: '',
                    });
                    setSelectedIndicatorTemplate(null);
                    setIsModalVisible(true);
                };

                const showEditIndicatorModal = (year, indicator) => {
                    setCurrentYear(year);
                    setEditingIndicator(indicator);
                    const template = templates.find(t => t.name === indicator.name);
                    setSelectedIndicatorTemplate(template);
                    form.setFieldsValue({
                        year: dayjs(year, 'YYYY'),
                        agreementId: indicator.agreementId,
                        companyId: indicator.companyId,
                        indicatorTemplateId: template ? template.id : null,
                        targetValue: indicator.target,
                    });
                    setIsModalVisible(true);
                };

                const handleModalOk = () => {
                    form.validateFields()
                        .then(values => {
                            const template = templates.find(t => t.id === values.indicatorTemplateId);
                            const agreement = project.agreements.find(a => a.id === values.agreementId);
                            const company = project.companies.find(c => c.id === values.companyId);
                            const targetYearStr = values.year.format('YYYY');

                            const newIndicatorData = {
                                name: template.name,
                                target: values.targetValue,
                                agreementId: values.agreementId,
                                companyId: values.companyId,
                                agreementName: agreement?.name,
                                companyName: company?.name,
                                actual: '待反馈',
                                status: '进行中',
                            };

                            if (editingIndicator) {
                                setBreakdownPlan(currentPlan => {
                                    let newPlan = JSON.parse(JSON.stringify(currentPlan));

                                    const originalYearData = newPlan.find(y => y.year === currentYear);
                                    if (originalYearData) {
                                        originalYearData.items = originalYearData.items.filter(
                                            item => item.id !== editingIndicator.id
                                        );
                                    }

                                    let targetYearData = newPlan.find(y => y.year === targetYearStr);
                                    if (!targetYearData) {
                                        targetYearData = { year: targetYearStr, items: [] };
                                        newPlan.push(targetYearData);
                                        newPlan.sort((a, b) => a.year.localeCompare(b.year));
                                    }
                                    targetYearData.items.push({ ...editingIndicator, ...newIndicatorData });

                                    return newPlan;
                                });
                                message.success('指标修改成功');
                            } else {
                                const newIndicator = { ...newIndicatorData, id: `${targetYearStr}-${Date.now()}` };
                                setBreakdownPlan(currentPlan => {
                                    const newPlan = JSON.parse(JSON.stringify(currentPlan));
                                    let targetYearData = newPlan.find(y => y.year === targetYearStr);
                                    if (!targetYearData) {
                                        targetYearData = { year: targetYearStr, items: [] };
                                        newPlan.push(targetYearData);
                                        newPlan.sort((a, b) => a.year.localeCompare(b.year));
                                    }
                                    targetYearData.items.push(newIndicator);
                                    return newPlan;
                                });
                                message.success('指标添加成功');
                            }
                            setIsModalVisible(false);
                        })
                        .catch(info => {
                            console.log('Validate Failed:', info);
                        });
                };

                const handleModalCancel = () => {
                    setIsModalVisible(false);
                };

                const handleDeleteIndicator = (year, indicatorId) => {
                    setBreakdownPlan(plan =>
                        plan.map(yearData =>
                            yearData.year === year
                                ? { ...yearData, items: yearData.items.filter(item => item.id !== indicatorId) }
                                : yearData
                        )
                    );
                    message.success('指标删除成功');
                };

                const handleAddYear = () => {
                    addYearForm.validateFields().then(values => {
                        const year = values.year.format('YYYY');
                        const yearExists = breakdownPlan.some(y => y.year === year);
                        if (yearExists) {
                            message.warning('该年度已存在！');
                            return;
                        }
                        const newPlan = [...breakdownPlan, { year, items: [] }];
                        newPlan.sort((a, b) => a.year.localeCompare(b.year));
                        setBreakdownPlan(newPlan);
                        setIsAddYearModalVisible(false);
                        addYearForm.resetFields();
                    });
                };

                const handleSave = () => {
                    message.success('指标拆解保存成功！');
                    onSave(breakdownPlan);
                };

                const handleIndicatorTemplateChange = value => {
                    const selected = templates.find(t => t.id === value);
                    setSelectedIndicatorTemplate(selected);
                };

                return (
                    <Card>
                        <div
                            style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: 24,
                            }}
                        >
                            <Space>
                                <Button onClick={onBack}>返回列表</Button>
                                <Typography.Title level={4} style={{ margin: 0 }}>
                                    项目指标拆解
                                </Typography.Title>
                            </Space>
                            <Button type="primary" onClick={handleSave}>
                                保存
                            </Button>
                        </div>
                        <Form layout="vertical">
                            <Row gutter={24}>
                                <Col span={12}>
                                    <Card title="协议约定内容" style={{ height: '100%' }}>
                                        <Form.Item required>
                                            <Upload beforeUpload={() => false}>
                                                <Button icon={<UploadOutlined />}>上传附件</Button>
                                            </Upload>
                                            <div
                                                style={{
                                                    marginTop: 16,
                                                    border: '1px solid #d9d9d9',
                                                    height: 400,
                                                    padding: 8,
                                                    borderRadius: 6,
                                                    overflowY: 'auto',
                                                }}
                                            >
                                                <Empty description="请上传协议文件以预览" />
                                            </div>
                                        </Form.Item>
                                    </Card>
                                </Col>
                                <Col span={12}>
                                    <Card title="指标计划表" style={{ height: '100%' }}>
                                        <Form.Item>
                                            {breakdownPlan.length > 0 ? (
                                                <Timeline>
                                                    {breakdownPlan.map(yearData => (
                                                        <Timeline.Item key={yearData.year}>
                                                            <b>{yearData.year}年</b>{' '}
                                                            <Button
                                                                size="small"
                                                                type="link"
                                                                onClick={() => showAddIndicatorModal(yearData.year)}
                                                            >
                                                                添加指标
                                                            </Button>
                                                            {yearData.items.map(item => (
                                                                <Card
                                                                    size="small"
                                                                    style={{ marginTop: 8 }}
                                                                    key={item.id}
                                                                >
                                                                    <div
                                                                        style={{
                                                                            display: 'flex',
                                                                            justifyContent: 'space-between',
                                                                            alignItems: 'center',
                                                                        }}
                                                                    >
                                                                        <Descriptions size="small" column={1}>
                                                                            <Descriptions.Item label="指标名称">
                                                                                {item.name}
                                                                            </Descriptions.Item>
                                                                            <Descriptions.Item label="约定目标">
                                                                                {item.target}
                                                                            </Descriptions.Item>
                                                                            <Descriptions.Item label="关联协议">
                                                                                {project.agreements?.find(
                                                                                    a => a.id === item.agreementId
                                                                                )?.name || 'N/A'}
                                                                            </Descriptions.Item>
                                                                            <Descriptions.Item label="达标公司">
                                                                                {project.companies?.find(
                                                                                    c => c.id === item.companyId
                                                                                )?.name || 'N/A'}
                                                                            </Descriptions.Item>
                                                                        </Descriptions>
                                                                        <Space direction="vertical">
                                                                            <Tooltip title="编辑">
                                                                                <Button
                                                                                    size="small"
                                                                                    type="text"
                                                                                    icon={<EditOutlined />}
                                                                                    onClick={() =>
                                                                                        showEditIndicatorModal(
                                                                                            yearData.year,
                                                                                            item
                                                                                        )
                                                                                    }
                                                                                />
                                                                            </Tooltip>
                                                                            <Popconfirm
                                                                                title="删除指标"
                                                                                description="您确定要删除这个指标吗?"
                                                                                onConfirm={() =>
                                                                                    handleDeleteIndicator(
                                                                                        yearData.year,
                                                                                        item.id
                                                                                    )
                                                                                }
                                                                                okText="确认"
                                                                                cancelText="取消"
                                                                            >
                                                                                <Tooltip title="删除">
                                                                                    <Button
                                                                                        size="small"
                                                                                        type="text"
                                                                                        danger
                                                                                        icon={<DeleteOutlined />}
                                                                                    />
                                                                                </Tooltip>
                                                                            </Popconfirm>
                                                                        </Space>
                                                                    </div>
                                                                </Card>
                                                            ))}
                                                        </Timeline.Item>
                                                    ))}
                                                </Timeline>
                                            ) : (
                                                <Empty description="暂无指标计划，请先添加年度" />
                                            )}
                                            <Button
                                                type="dashed"
                                                block
                                                icon={<PlusOutlined />}
                                                onClick={() => setIsAddYearModalVisible(true)}
                                            >
                                                添加年度
                                            </Button>
                                        </Form.Item>
                                    </Card>
                                </Col>
                            </Row>
                        </Form>
                        <Modal
                            title={editingIndicator ? '编辑指标' : '添加指标'}
                            open={isModalVisible}
                            onOk={handleModalOk}
                            onCancel={handleModalCancel}
                        >
                            <Form form={form} layout="vertical" initialValues={{ year: dayjs(currentYear, 'YYYY') }}>
                                <Form.Item name="year" label="完成年度" rules={[{ required: true }]}>
                                    <DatePicker picker="year" style={{ width: '100%' }} />
                                </Form.Item>
                                <Form.Item
                                    name="agreementId"
                                    label="关联协议"
                                    rules={[{ required: true, message: '请选择关联协议' }]}
                                >
                                    <Select placeholder="请选择关联协议">
                                        {project.agreements?.map(a => (
                                            <Select.Option key={a.id} value={a.id}>
                                                {a.name}
                                            </Select.Option>
                                        ))}
                                    </Select>
                                </Form.Item>
                                <Form.Item
                                    name="companyId"
                                    label="约定达标项目公司"
                                    rules={[{ required: true, message: '请选择项目公司' }]}
                                >
                                    <Select placeholder="请选择项目公司">
                                        {project.companies?.map(c => (
                                            <Select.Option key={c.id} value={c.id}>
                                                {c.name}
                                            </Select.Option>
                                        ))}
                                    </Select>
                                </Form.Item>
                                <Form.Item
                                    name="indicatorTemplateId"
                                    label="约定指标"
                                    rules={[{ required: true, message: '请选择指标模板' }]}
                                >
                                    <Select placeholder="请选择指标模板" onChange={handleIndicatorTemplateChange}>
                                        {templates
                                            .filter(t => t.status === 'enabled')
                                            .map(t => (
                                                <Select.Option key={t.id} value={t.id}>
                                                    {t.name}
                                                </Select.Option>
                                            ))}
                                    </Select>
                                </Form.Item>
                                {selectedIndicatorTemplate && (
                                    <Form.Item
                                        name="targetValue"
                                        label={`目标值 (${selectedIndicatorTemplate.name})`}
                                        rules={[{ required: true, message: '请输入目标值' }]}
                                    >
                                        <Input placeholder={`请输入${selectedIndicatorTemplate.primaryKey}的目标值`} />
                                    </Form.Item>
                                )}
                            </Form>
                        </Modal>
                        <Modal
                            title="添加年度"
                            open={isAddYearModalVisible}
                            onOk={handleAddYear}
                            onCancel={() => setIsAddYearModalVisible(false)}
                        >
                            <Form form={addYearForm} layout="vertical">
                                <Form.Item
                                    name="year"
                                    label="选择年度"
                                    rules={[{ required: true, message: '请选择年度' }]}
                                >
                                    <DatePicker picker="year" style={{ width: '100%' }} />
                                </Form.Item>
                            </Form>
                        </Modal>
                    </Card>
                );
            };
            const PolicyBreakdown = ({ project, onBack, onSave }) => {
                const [localPolicies, setLocalPolicies] = useState(() =>
                    JSON.parse(JSON.stringify(project.policies || []))
                );
                const [isPolicyModalVisible, setIsPolicyModalVisible] = useState(false);
                const [editingData, setEditingData] = useState(null);
                const [policyForm] = Form.useForm();

                const showModal = config => {
                    setEditingData(config);
                    if (config.data) {
                        policyForm.setFieldsValue({
                            ...config.data,
                            year: config.data.year ? dayjs(config.data.year, 'YYYY') : null,
                        });
                    } else {
                        policyForm.resetFields();
                    }
                    setIsPolicyModalVisible(true);
                };

                const handleModalOk = () => {
                    policyForm
                        .validateFields()
                        .then(values => {
                            const { type, parentKey, data } = editingData;

                            setLocalPolicies(currentPolicies => {
                                const newPolicies = JSON.parse(JSON.stringify(currentPolicies));

                                if (type === 'category') {
                                    if (data) {
                                        // Editing category
                                        const policyToEdit = newPolicies.find(p => p.key === data.key);
                                        if (policyToEdit) policyToEdit.title = values.title;
                                    } else {
                                        // Adding new category
                                        newPolicies.push({
                                            key: `p-${project.id}-${Date.now()}`,
                                            title: values.title,
                                            children: [],
                                        });
                                    }
                                } else if (type === 'item') {
                                    const parentPolicy = newPolicies.find(p => p.key === parentKey);
                                    if (!parentPolicy) return currentPolicies;

                                    const newItem = {
                                        title: values.title,
                                        year: values.year.format('YYYY'),
                                        status: '待配置',
                                    };

                                    if (data) {
                                        // Editing item
                                        const itemIndex = parentPolicy.children.findIndex(c => c.key === data.key);
                                        if (itemIndex > -1) {
                                            parentPolicy.children[itemIndex] = {
                                                ...parentPolicy.children[itemIndex],
                                                ...newItem,
                                            };
                                        }
                                    } else {
                                        // Adding new item
                                        parentPolicy.children.push({
                                            ...newItem,
                                            key: `${parentKey}-${Date.now()}`,
                                        });
                                    }
                                }
                                return newPolicies;
                            });

                            message.success(data ? '修改成功' : '添加成功');
                            setIsPolicyModalVisible(false);
                        })
                        .catch(info => {
                            console.log('Validate Failed:', info);
                        });
                };

                const handleDelete = (key, parentKey) => {
                    setLocalPolicies(currentPolicies => {
                        let newPolicies = JSON.parse(JSON.stringify(currentPolicies));
                        if (parentKey) {
                            const parentPolicy = newPolicies.find(p => p.key === parentKey);
                            if (parentPolicy) {
                                parentPolicy.children = parentPolicy.children.filter(c => c.key !== key);
                            }
                        } else {
                            newPolicies = newPolicies.filter(p => p.key !== key);
                        }
                        return newPolicies;
                    });
                    message.success('删除成功');
                };

                const handleSave = () => {
                    message.success('政策拆解保存成功！');
                    onSave(localPolicies);
                };

                const generateTreeData = policies => {
                    const root = {
                        title: '项目拟兑现政策',
                        key: 'root',
                        children: (policies || []).map(p => ({
                            title: p.title,
                            key: p.key,
                            data: p,
                            type: 'category',
                            children: (p.children || []).map(c => ({
                                title: `${c.year} - ${c.title}`,
                                key: c.key,
                                data: c,
                                type: 'item',
                                parentKey: p.key,
                                isLeaf: true,
                            })),
                        })),
                    };
                    return [root];
                };

                const titleRender = node => {
                    if (node.key === 'root') {
                        return <b>{node.title}</b>;
                    }

                    return (
                        <div
                            style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                flexGrow: 1,
                            }}
                        >
                            <span>{node.title}</span>
                            <Space>
                                <Tooltip title="编辑">
                                    <Button
                                        size="small"
                                        type="text"
                                        icon={<EditOutlined />}
                                        onClick={e => {
                                            e.stopPropagation();
                                            showModal({ type: node.type, parentKey: node.parentKey, data: node.data });
                                        }}
                                    />
                                </Tooltip>
                                <Popconfirm
                                    title={`删除${node.type === 'category' ? '政策分类' : '兑现计划'}`}
                                    description="您确定要删除吗? 此操作不可撤销。"
                                    onConfirm={e => {
                                        e.stopPropagation();
                                        handleDelete(node.key, node.parentKey);
                                    }}
                                    onCancel={e => e.stopPropagation()}
                                    okText="确认"
                                    cancelText="取消"
                                >
                                    <Tooltip title="删除">
                                        <Button
                                            size="small"
                                            type="text"
                                            danger
                                            icon={<DeleteOutlined />}
                                            onClick={e => e.stopPropagation()}
                                        />
                                    </Tooltip>
                                </Popconfirm>
                                {node.type === 'category' && (
                                    <Tooltip title="添加兑现计划">
                                        <Button
                                            size="small"
                                            type="text"
                                            icon={<PlusOutlined />}
                                            onClick={e => {
                                                e.stopPropagation();
                                                showModal({ type: 'item', parentKey: node.key });
                                            }}
                                        />
                                    </Tooltip>
                                )}
                            </Space>
                        </div>
                    );
                };

                return (
                    <Card>
                        <div
                            style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: 24,
                            }}
                        >
                            <Space>
                                <Button onClick={onBack}>返回列表</Button>
                                <Typography.Title level={4} style={{ margin: 0 }}>
                                    兑现政策拆解
                                </Typography.Title>
                            </Space>
                            <Button type="primary" onClick={handleSave}>
                                保存
                            </Button>
                        </div>
                        <Form layout="vertical">
                            <Row gutter={24}>
                                <Col span={12}>
                                    <Card title="协议约定政策内容" style={{ height: '100%' }}>
                                        <Form.Item required>
                                            <Upload beforeUpload={() => false}>
                                                <Button icon={<UploadOutlined />}>上传附件</Button>
                                            </Upload>
                                            <div
                                                style={{
                                                    marginTop: 16,
                                                    border: '1px solid #d9d9d9',
                                                    height: 400,
                                                    padding: 8,
                                                    borderRadius: 6,
                                                    overflowY: 'auto',
                                                }}
                                            >
                                                <Empty description="请上传协议文件以预览" />
                                            </div>
                                        </Form.Item>
                                    </Card>
                                </Col>
                                <Col span={12}>
                                    <Card
                                        title="政策支持树"
                                        style={{ height: '100%' }}
                                        extra={
                                            <Button
                                                icon={<PlusOutlined />}
                                                type="primary"
                                                onClick={() => showModal({ type: 'category' })}
                                            >
                                                添加政策分类
                                            </Button>
                                        }
                                    >
                                        <Tree
                                            motion={null}
                                            showLine
                                            defaultExpandAll
                                            treeData={generateTreeData(localPolicies)}
                                            titleRender={titleRender}
                                        />
                                    </Card>
                                </Col>
                            </Row>
                        </Form>
                        <Modal
                            title={
                                editingData?.data
                                    ? editingData.type === 'category'
                                        ? '编辑政策分类'
                                        : '编辑兑现计划'
                                    : editingData?.type === 'category'
                                    ? '添加政策分类'
                                    : '添加兑现计划'
                            }
                            open={isPolicyModalVisible}
                            onOk={handleModalOk}
                            onCancel={() => setIsPolicyModalVisible(false)}
                        >
                            <Form form={policyForm} layout="vertical">
                                <Form.Item
                                    name="title"
                                    label={editingData?.type === 'category' ? '政策分类名称' : '兑现计划名称'}
                                    rules={[{ required: true, message: '请输入名称' }]}
                                >
                                    <Input />
                                </Form.Item>
                                {editingData?.type === 'item' && (
                                    <Form.Item
                                        name="year"
                                        label="兑现年度"
                                        rules={[{ required: true, message: '请选择兑现年度' }]}
                                    >
                                        <DatePicker picker="year" style={{ width: '100%' }} />
                                    </Form.Item>
                                )}
                            </Form>
                        </Modal>
                    </Card>
                );
            };
            const ProjectList = ({ onEntry, onDetail, onIndicator, onPolicy }) => {
                const [projects, setProjects] = useLocalStorage('projects', MOCK_DB.projects);
                const [filteredProjects, setFilteredProjects] = useState(projects);
                const [projectDetails] = useLocalStorage('projectDetails', MOCK_DB.projectDetails);

                const handleSearch = values => {
                    const { name, company, manager, unit, signDate } = values;
                    let data = [...projects];
                    if (name) data = data.filter(p => p.name.includes(name));
                    if (company) data = data.filter(p => p.company.includes(company));
                    if (manager) data = data.filter(p => p.manager === manager);
                    if (unit) data = data.filter(p => p.unit === unit);
                    if (signDate && signDate.length === 2) {
                        data = data.filter(
                            p => dayjs(p.signDate).isAfter(signDate[0]) && dayjs(p.signDate).isBefore(signDate[1])
                        );
                    }
                    setFilteredProjects(data);
                };

                const columns = [
                    {
                        title: '项目名称',
                        dataIndex: 'name',
                        key: 'name',
                        width: 250,
                        render: (text, record) => {
                            const details = projectDetails[record.id];
                            if (!details || !details.agreements) return text;

                            const currentYear = dayjs().year().toString();
                            const needsWarning = details.agreements.some(
                                a => a.midtermAssessmentYear === currentYear || a.finalAssessmentYear === currentYear
                            );

                            return (
                                <Space>
                                    {text}
                                    {needsWarning && (
                                        <Tooltip title="该项目在本年度有考核任务">
                                            <WarningOutlined style={{ color: 'orange' }} />
                                        </Tooltip>
                                    )}
                                </Space>
                            );
                        },
                    },
                    { title: '项目公司名称', dataIndex: 'company', key: 'company', width: 200 },
                    { title: '签订协议数量', dataIndex: 'agreementCount', key: 'agreementCount' },
                    {
                        title: '招商经理',
                        dataIndex: 'manager',
                        key: 'manager',
                        render: (text, record) => `${text} (${record.managerPhone || '无'})`,
                    },
                    { title: '招商单位', dataIndex: 'unit', key: 'unit', width: 200 },
                    {
                        title: '操作',
                        key: 'action',
                        fixed: 'right',
                        width: 300,
                        render: (_, record) => (
                            <Space size="small">
                                <Button type="link" onClick={() => onDetail(record)}>
                                    详情
                                </Button>
                                <Button type="link" onClick={() => onEntry(record)}>
                                    修改
                                </Button>
                                <Button type="link" onClick={() => onIndicator(record)}>
                                    项目指标拆解
                                </Button>
                                <Button type="link" onClick={() => onPolicy(record)}>
                                    兑现政策拆解
                                </Button>
                            </Space>
                        ),
                    },
                ];

                return (
                    <Card title="项目列表">
                        <Form layout="inline" onFinish={handleSearch} style={{ marginBottom: 16 }}>
                            <Form.Item name="name">
                                <Input placeholder="项目名称" />
                            </Form.Item>
                            <Form.Item name="company">
                                <Input placeholder="项目公司名称" />
                            </Form.Item>
                            <Form.Item name="manager">
                                <Select placeholder="招商经理" style={{ width: 120 }} allowClear>
                                    <Select.Option value="王经理">王经理</Select.Option>
                                    <Select.Option value="刘经理">刘经理</Select.Option>
                                    <Select.Option value="赵经理">赵经理</Select.Option>
                                </Select>
                            </Form.Item>
                            <Form.Item name="unit">
                                <Select placeholder="招商单位" style={{ width: 200 }} allowClear>
                                    <Select.Option value="高新技术产业招商局">高新技术产业招商局</Select.Option>
                                    <Select.Option value="重大项目招商办公室">重大项目招商办公室</Select.Option>
                                </Select>
                            </Form.Item>
                            <Form.Item name="signDate">
                                <RangePicker />
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    搜索
                                </Button>
                            </Form.Item>
                            <Form.Item>
                                <Button
                                    onClick={() => {
                                        setFilteredProjects(projects);
                                    }}
                                >
                                    重置
                                </Button>
                            </Form.Item>
                            <Form.Item style={{ marginLeft: 'auto' }}>
                                <Button type="primary" icon={<PlusOutlined />} onClick={() => onEntry(null)}>
                                    项目录入
                                </Button>
                            </Form.Item>
                        </Form>
                        <Table columns={columns} dataSource={filteredProjects} rowKey="id" scroll={{ x: 1300 }} />
                    </Card>
                );
            };
            const GovernmentProjectManagement = () => {
                const [view, setView] = useState('list'); // 'list', 'detail', 'entry', 'indicator', 'policy'
                const [activeProject, setActiveProject] = useState(null);
                const [projectDetails, setProjectDetails] = useLocalStorage('projectDetails', MOCK_DB.projectDetails);
                const [isCompanyTypeModalVisible, setIsCompanyTypeModalVisible] = useState(false);
                const [companyType, setCompanyType] = useState(null);

                const handleShowView = (viewName, project) => {
                    setActiveProject(project);
                    if (viewName === 'entry' && !project) {
                        // This is for new entry
                        setCompanyType(null); // Reset before opening
                        setIsCompanyTypeModalVisible(true);
                    } else {
                        setView(viewName);
                    }
                };

                const handleBackToList = () => {
                    setActiveProject(null);
                    setView('list');
                };

                const handleSaveProject = values => {
                    // 在这里处理保存逻辑，例如更新localStorage
                    console.log('Saving project:', values);
                    handleBackToList();
                };

                const handleCompanyTypeSelect = () => {
                    if (!companyType) {
                        message.error('请选择项目公司类型');
                        return;
                    }
                    setIsCompanyTypeModalVisible(false);
                    setView('entry'); // activeProject is already null from handleShowView
                };

                const projectDetail = activeProject ? projectDetails[activeProject.id] || activeProject : null;

                const handleSaveIndicatorBreakdown = updatedIndicatorsPlan => {
                    const updatedProject = { ...projectDetail, indicators: updatedIndicatorsPlan };
                    setProjectDetails(prev => ({ ...prev, [projectDetail.id]: updatedProject }));
                    handleBackToList();
                };

                const handleSavePolicyBreakdown = updatedPolicies => {
                    const updatedProject = { ...projectDetail, policies: updatedPolicies };
                    setProjectDetails(prev => ({ ...prev, [projectDetail.id]: updatedProject }));
                    handleBackToList();
                };

                const renderContent = () => {
                    switch (view) {
                        case 'entry':
                            return (
                                <ProjectEntry
                                    project={activeProject}
                                    onBack={handleBackToList}
                                    onSave={handleSaveProject}
                                    companyType={projectDetail?.companyType || companyType}
                                />
                            );
                        case 'detail':
                            return (
                                <ProjectDetail
                                    project={projectDetail}
                                    setProjectDetails={setProjectDetails}
                                    onBack={handleBackToList}
                                />
                            );
                        case 'indicator':
                            return (
                                <IndicatorBreakdown
                                    project={projectDetail}
                                    onBack={handleBackToList}
                                    onSave={handleSaveIndicatorBreakdown}
                                />
                            );
                        case 'policy':
                            return (
                                <PolicyBreakdown
                                    project={projectDetail}
                                    onBack={handleBackToList}
                                    onSave={handleSavePolicyBreakdown}
                                />
                            );
                        default:
                            return (
                                <ProjectList
                                    onEntry={project => handleShowView('entry', project)}
                                    onDetail={project => handleShowView('detail', project)}
                                    onIndicator={project => handleShowView('indicator', project)}
                                    onPolicy={project => handleShowView('policy', project)}
                                />
                            );
                    }
                };

                return (
                    <>
                        {renderContent()}
                        <Modal
                            title="选择项目公司类型"
                            open={isCompanyTypeModalVisible}
                            onOk={handleCompanyTypeSelect}
                            onCancel={() => setIsCompanyTypeModalVisible(false)}
                            okText="确定"
                            cancelText="取消"
                        >
                            <p style={{ margin: '24px 0' }}>请选择您要录入的项目公司所属类型：</p>
                            <Radio.Group onChange={e => setCompanyType(e.target.value)} value={companyType}>
                                <Radio value="manufacturing">制造业</Radio>
                                <Radio value="non-manufacturing">非制造业</Radio>
                            </Radio.Group>
                        </Modal>
                    </>
                );
            };

            // --- 3. 履约节点跟踪看板 (政务端) ---
            const KanbanBoard = () => {
                const [viewMode, setViewMode] = useState('indicator');
                const [tasks, setTasks] = useLocalStorage('kanbanTasks', MOCK_DB.kanbanTasks);
                const [displayTasks, setDisplayTasks] = useState(tasks);
                const [isFeedbackModalVisible, setIsFeedbackModalVisible] = useState(false);
                const [currentTask, setCurrentTask] = useState(null);
                const [feedbackForm] = Form.useForm();
                const [filterForm] = Form.useForm();

                useEffect(() => {
                    setDisplayTasks(tasks);
                }, [tasks]);

                const showFeedbackModal = task => {
                    setCurrentTask(task);
                    feedbackForm.resetFields();
                    setIsFeedbackModalVisible(true);
                };

                const handleFeedbackOk = () => {
                    feedbackForm.validateFields().then(values => {
                        message.success('反馈提交成功！');
                        const updatedTasks = tasks.map(t => (t.id === currentTask.id ? { ...t, status: '待审核' } : t));
                        setTasks(updatedTasks);
                        filterForm.submit(); // Re-apply filter to update view
                        setIsFeedbackModalVisible(false);
                    });
                };

                const handleFeedbackCancel = () => {
                    setIsFeedbackModalVisible(false);
                };

                const handleFilter = values => {
                    let filtered = [...tasks];
                    if (values.projectName) {
                        filtered = filtered.filter(t => t.projectName === values.projectName);
                    }
                    if (values.companyName) {
                        filtered = filtered.filter(t => t.projectCompany === values.companyName);
                    }
                    if (values.year) {
                        filtered = filtered.filter(t => dayjs(t.dueDate).isSame(values.year, 'year'));
                    }
                    if (values.status) {
                        filtered = filtered.filter(t => t.status === values.status);
                    }
                    setDisplayTasks(filtered);
                };

                const resetFilter = () => {
                    filterForm.resetFields();
                    setDisplayTasks(tasks);
                };

                const getStatusColor = status => {
                    switch (status) {
                        case '未开始':
                            return 'grey';
                        case '进行中':
                            return 'blue';
                        case '待审核':
                            return 'orange';
                        case '已确认':
                            return 'green';
                        case '已逾期':
                            return 'red';
                        case '待修改提交':
                            return '#faad14';
                        default:
                            return 'default';
                    }
                };

                const renderIndicatorView = () => {
                    const columns = {
                        未开始: displayTasks.filter(t => t.status === '未开始'),
                        进行中: displayTasks.filter(t => t.status === '进行中'),
                        待审核: displayTasks.filter(t => t.status === '待审核'),
                        已确认: displayTasks.filter(t => t.status === '已确认'),
                        待修改提交: displayTasks.filter(t => t.status === '待修改提交'),
                        已逾期: displayTasks.filter(t => t.status === '已逾期'),
                    };

                    return (
                        <div className="kanban-board">
                            {Object.entries(columns).map(([title, tasks]) => (
                                <div key={title} className="kanban-column">
                                    <div className="kanban-column-title">
                                        {title} ({tasks.length})
                                    </div>
                                    <div className="kanban-cards">
                                        {tasks.length > 0 ? (
                                            tasks.map(task => (
                                                <Card key={task.id} className="kanban-card" hoverable>
                                                    <p>
                                                        <strong>{task.indicatorName}</strong>
                                                    </p>
                                                    <p>
                                                        <small>项目: {task.projectName}</small>
                                                    </p>
                                                    <p>
                                                        <small>企业: {task.targetCompany}</small>
                                                    </p>
                                                    <div
                                                        style={{
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            marginTop: 8,
                                                        }}
                                                    >
                                                        <Tag color={getStatusColor(task.status)}>{task.status}</Tag>
                                                        <Button
                                                            type="link"
                                                            size="small"
                                                            onClick={() => showFeedbackModal(task)}
                                                        >
                                                            反馈
                                                        </Button>
                                                    </div>
                                                </Card>
                                            ))
                                        ) : (
                                            <Empty image={Empty.PRESENTED_IMAGE_SIMPLE} description="暂无任务" />
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                };

                const renderProjectView = () => {
                    const projects = displayTasks.reduce((acc, task) => {
                        if (!acc[task.projectName]) {
                            acc[task.projectName] = {
                                name: task.projectName,
                                company: task.projectCompany,
                                indicators: [],
                            };
                        }
                        acc[task.projectName].indicators.push(task);
                        return acc;
                    }, {});

                    return (
                        <div style={{ padding: '16px 0', background: '#f0f2f5' }}>
                            <Row gutter={[16, 16]}>
                                {Object.keys(projects).length > 0 ? (
                                    Object.values(projects).map(project => (
                                        <Col span={24} key={project.name}>
                                            <Card title={`${project.name} - ${project.company}`}>
                                                <Row gutter={[16, 16]}>
                                                    {project.indicators.map(task => (
                                                        <Col xs={24} sm={12} md={8} key={task.id}>
                                                            <Card size="small" title={task.indicatorName}>
                                                                <p>约定达标企业: {task.targetCompany}</p>
                                                                <div
                                                                    style={{
                                                                        display: 'flex',
                                                                        justifyContent: 'space-between',
                                                                        alignItems: 'center',
                                                                        marginTop: 8,
                                                                    }}
                                                                >
                                                                    <Space>
                                                                        反馈状态:{' '}
                                                                        <Badge
                                                                            color={getStatusColor(task.status)}
                                                                            text={task.status}
                                                                        />
                                                                    </Space>
                                                                    <Button
                                                                        type="primary"
                                                                        size="small"
                                                                        onClick={() => showFeedbackModal(task)}
                                                                    >
                                                                        反馈
                                                                    </Button>
                                                                </div>
                                                            </Card>
                                                        </Col>
                                                    ))}
                                                </Row>
                                            </Card>
                                        </Col>
                                    ))
                                ) : (
                                    <Col span={24}>
                                        <Empty description="暂无符合筛选条件的项目" />
                                    </Col>
                                )}
                            </Row>
                        </div>
                    );
                };

                const indicatorStatuses = ['未开始', '进行中', '待审核', '已确认', '待修改提交', '已逾期'];

                return (
                    <Card
                        title="履约节点跟踪看板"
                        extra={
                            <Segmented
                                options={[
                                    { label: '指标维度', value: 'indicator' },
                                    { label: '项目维度', value: 'project' },
                                ]}
                                value={viewMode}
                                onChange={setViewMode}
                            />
                        }
                    >
                        <Form form={filterForm} onFinish={handleFilter} layout="inline" style={{ marginBottom: 16 }}>
                            <Form.Item name="projectName" label="项目名称">
                                <Select placeholder="请选择项目" style={{ width: 220 }} allowClear>
                                    {[...new Set(tasks.map(t => t.projectName))].map(name => (
                                        <Select.Option key={name} value={name}>
                                            {name}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Form.Item>
                            <Form.Item name="companyName" label="企业名称">
                                <Select placeholder="请选择企业" style={{ width: 200 }} allowClear>
                                    {[...new Set(tasks.map(t => t.projectCompany))].map(name => (
                                        <Select.Option key={name} value={name}>
                                            {name}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Form.Item>
                            <Form.Item name="year" label="年度">
                                <DatePicker picker="year" />
                            </Form.Item>
                            <Form.Item name="status" label="指标状态">
                                <Select placeholder="请选择状态" style={{ width: 150 }} allowClear>
                                    {indicatorStatuses.map(s => (
                                        <Select.Option key={s} value={s}>
                                            {s}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    筛选
                                </Button>
                            </Form.Item>
                            <Form.Item>
                                <Button onClick={resetFilter}>重置</Button>
                            </Form.Item>
                        </Form>

                        {viewMode === 'indicator' ? renderIndicatorView() : renderProjectView()}

                        <Modal
                            title="指标完成情况反馈"
                            open={isFeedbackModalVisible}
                            onOk={handleFeedbackOk}
                            onCancel={handleFeedbackCancel}
                        >
                            {currentTask && (
                                <Form form={feedbackForm} layout="vertical">
                                    <p>
                                        <strong>指标名称:</strong> {currentTask.indicatorName}
                                    </p>
                                    <p>
                                        <strong>所属项目:</strong> {currentTask.projectName}
                                    </p>
                                    <Form.Item label="完成值" name="completedValue" rules={[{ required: true }]}>
                                        <Input />
                                    </Form.Item>
                                    <Form.Item label="佐证材料" name="attachment" rules={[{ required: true }]}>
                                        <Upload beforeUpload={() => false}>
                                            <Button icon={<UploadOutlined />}>上传文件</Button>
                                        </Upload>
                                    </Form.Item>
                                    <Form.Item label="备注说明" name="remark">
                                        <Input.TextArea />
                                    </Form.Item>
                                </Form>
                            )}
                        </Modal>
                    </Card>
                );
            };

            // --- 4. 履约情况审核中心 ---
            const AuditCenter = () => {
                const [tasks, setTasks] = useLocalStorage('kanbanTasks', MOCK_DB.kanbanTasks);
                const [groupedTasks, setGroupedTasks] = useState([]);
                const [isModalVisible, setIsModalVisible] = useState(false);
                const [modalMode, setModalMode] = useState('audit'); // 'audit' or 'view'
                const [selectedTask, setSelectedTask] = useState(null);
                const [auditForm] = Form.useForm();
                const [filterForm] = Form.useForm();

                useEffect(() => {
                    const tasksToAudit = tasks.filter(t => ['待审核', '已确认', '待修改提交'].includes(t.status));

                    const grouped = tasksToAudit.reduce((acc, task) => {
                        const { projectName, projectCompany } = task;
                        if (!acc[projectName]) {
                            acc[projectName] = {
                                key: projectName,
                                projectName: projectName,
                                projectCompany: projectCompany,
                                pendingCount: 0,
                                children: [],
                            };
                        }
                        acc[projectName].children.push(task);
                        if (task.status === '待审核') {
                            acc[projectName].pendingCount++;
                        }
                        return acc;
                    }, {});

                    setGroupedTasks(Object.values(grouped));
                }, [tasks]);

                const showModal = (task, mode) => {
                    setSelectedTask(task);
                    setModalMode(mode);
                    auditForm.resetFields();
                    setIsModalVisible(true);
                };

                const handleAudit = () => {
                    auditForm
                        .validateFields()
                        .then(values => {
                            const { result, reason } = values;
                            const newStatus = result === 'pass' ? '已确认' : '待修改提交';

                            const updatedTasks = tasks.map(task => {
                                if (task.id === selectedTask.id) {
                                    return {
                                        ...task,
                                        status: newStatus,
                                        auditHistory: [
                                            ...(task.auditHistory || []),
                                            {
                                                time: dayjs().format('YYYY-MM-DD HH:mm'),
                                                action: result === 'pass' ? '确认，可入库' : '退回，重新修改',
                                                user: '管理员',
                                                content: reason || '审核通过',
                                            },
                                        ],
                                    };
                                }
                                return task;
                            });

                            setTasks(updatedTasks);
                            message.success('审核操作成功！');
                            setIsModalVisible(false);
                        })
                        .catch(info => {
                            console.log('Validate Failed:', info);
                        });
                };

                const handleFilter = values => {
                    let allTasks = tasks.filter(t => ['待审核', '已确认', '待修改提交'].includes(t.status));
                    const { indicatorName, projectName, targetCompany, submissionDate, status } = values;

                    if (indicatorName) allTasks = allTasks.filter(t => t.indicatorName.includes(indicatorName));
                    if (projectName) allTasks = allTasks.filter(t => t.projectName === projectName);
                    if (targetCompany) allTasks = allTasks.filter(t => t.targetCompany === targetCompany);
                    if (status) allTasks = allTasks.filter(t => t.status === status);
                    if (submissionDate && submissionDate.length === 2) {
                        allTasks = allTasks.filter(t => {
                            if (!t.submissionTime) return false;
                            const submissionDay = dayjs(t.submissionTime, 'YYYY-MM-DD');
                            return submissionDay.isBetween(
                                submissionDate[0].startOf('day'),
                                submissionDate[1].endOf('day')
                            );
                        });
                    }

                    const grouped = allTasks.reduce((acc, task) => {
                        const { projectName, projectCompany } = task;
                        if (!acc[projectName]) {
                            acc[projectName] = {
                                key: projectName,
                                projectName: projectName,
                                projectCompany: projectCompany,
                                pendingCount: 0,
                                children: [],
                            };
                        }
                        acc[projectName].children.push(task);
                        if (task.status === '待审核') {
                            acc[projectName].pendingCount++;
                        }
                        return acc;
                    }, {});

                    setGroupedTasks(Object.values(grouped));
                };

                const resetFilter = () => {
                    filterForm.resetFields();
                    const tasksToAudit = tasks.filter(t => ['待审核', '已确认', '待修改提交'].includes(t.status));
                    const grouped = tasksToAudit.reduce((acc, task) => {
                        const { projectName, projectCompany } = task;
                        if (!acc[projectName]) {
                            acc[projectName] = {
                                key: projectName,
                                projectName: projectName,
                                projectCompany: projectCompany,
                                pendingCount: 0,
                                children: [],
                            };
                        }
                        acc[projectName].children.push(task);
                        if (task.status === '待审核') {
                            acc[projectName].pendingCount++;
                        }
                        return acc;
                    }, {});
                    setGroupedTasks(Object.values(grouped));
                };

                const projectTableColumns = [
                    { title: '项目名称', dataIndex: 'projectName', key: 'projectName' },
                    { title: '项目公司', dataIndex: 'projectCompany', key: 'projectCompany' },
                    {
                        title: '待审核指标数',
                        dataIndex: 'pendingCount',
                        key: 'pendingCount',
                        render: count => <Badge count={count} />,
                    },
                ];

                const innerTableColumns = [
                    { title: '指标名称', dataIndex: 'indicatorName', key: 'indicatorName' },
                    { title: '约定达标企业', dataIndex: 'targetCompany', key: 'targetCompany' },
                    { title: '提交时间', dataIndex: 'submissionTime', key: 'submissionTime' },
                    {
                        title: '审核状态',
                        dataIndex: 'status',
                        key: 'status',
                        render: status => {
                            const color = status === '待审核' ? 'orange' : status === '已确认' ? 'green' : 'gold';
                            return <Tag color={color}>{status}</Tag>;
                        },
                    },
                    {
                        title: '操作',
                        key: 'action',
                        render: (_, record) => {
                            if (record.status === '待审核') {
                                return (
                                    <Button type="primary" size="small" onClick={() => showModal(record, 'audit')}>
                                        审核
                                    </Button>
                                );
                            }
                            if (record.status === '已确认' || record.status === '待修改提交') {
                                return (
                                    <Button size="small" onClick={() => showModal(record, 'view')}>
                                        查看详情
                                    </Button>
                                );
                            }
                            return null;
                        },
                    },
                ];

                const auditStatuses = ['待审核', '已确认', '待修改提交'];

                return (
                    <Card title="履约情况审核中心">
                        <Form form={filterForm} onFinish={handleFilter} layout="inline" style={{ marginBottom: 16 }}>
                            <Form.Item name="indicatorName" label="指标名称">
                                <Input placeholder="请输入" allowClear />
                            </Form.Item>
                            <Form.Item name="projectName" label="项目名称">
                                <Select placeholder="请选择" style={{ width: 200 }} allowClear>
                                    {[...new Set(tasks.map(t => t.projectName))].map(name => (
                                        <Select.Option key={name} value={name}>
                                            {name}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Form.Item>
                            <Form.Item name="targetCompany" label="约定达标企业">
                                <Select placeholder="请选择" style={{ width: 200 }} allowClear>
                                    {[...new Set(tasks.map(t => t.targetCompany))].map(name => (
                                        <Select.Option key={name} value={name}>
                                            {name}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Form.Item>
                            <Form.Item name="submissionDate" label="提交日期">
                                <RangePicker />
                            </Form.Item>
                            <Form.Item name="status" label="审核状态">
                                <Select placeholder="请选择" style={{ width: 140 }} allowClear>
                                    {auditStatuses.map(s => (
                                        <Select.Option key={s} value={s}>
                                            {s}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    查询
                                </Button>
                            </Form.Item>
                            <Form.Item>
                                <Button onClick={resetFilter}>重置</Button>
                            </Form.Item>
                        </Form>

                        <Table
                            columns={projectTableColumns}
                            dataSource={groupedTasks}
                            rowKey="key"
                            expandable={{
                                expandedRowRender: record => (
                                    <Table
                                        columns={innerTableColumns}
                                        dataSource={record.children}
                                        rowKey="id"
                                        pagination={false}
                                    />
                                ),
                            }}
                        />

                        <Modal
                            title={modalMode === 'audit' ? '履约情况审核' : '履约情况详情'}
                            open={isModalVisible}
                            onCancel={() => setIsModalVisible(false)}
                            width={1000}
                            footer={
                                modalMode === 'audit'
                                    ? [
                                          <Button key="back" onClick={() => setIsModalVisible(false)}>
                                              取消
                                          </Button>,
                                          <Button key="submit" type="primary" onClick={handleAudit}>
                                              提交审核结果
                                          </Button>,
                                      ]
                                    : [
                                          <Button key="back" onClick={() => setIsModalVisible(false)}>
                                              关闭
                                          </Button>,
                                      ]
                            }
                        >
                            {selectedTask && (
                                <div>
                                    <Row gutter={24} style={{ marginBottom: 24 }}>
                                        <Col span={12}>
                                            <Card title="指标要求" bodyStyle={{ minHeight: 200 }}>
                                                <p>
                                                    <strong>指标名称：</strong>
                                                    {selectedTask.indicatorName}
                                                </p>
                                                <p>
                                                    <strong>所属项目：</strong>
                                                    {selectedTask.projectName}
                                                </p>
                                                <p>
                                                    <strong>约定目标：</strong>
                                                    <Tag color="blue">{selectedTask.targetValue || '无'}</Tag>
                                                </p>
                                            </Card>
                                        </Col>
                                        <Col span={12}>
                                            <Card title="企业反馈" bodyStyle={{ minHeight: 200 }}>
                                                <p>
                                                    <strong>反馈情况：</strong>
                                                    {selectedTask.completedValue}
                                                </p>
                                                <p>
                                                    <strong>证明材料：</strong>
                                                </p>
                                                <Upload fileList={selectedTask.submittedFiles} disabled>
                                                    <Button icon={<UploadOutlined />}>查看附件</Button>
                                                </Upload>
                                            </Card>
                                        </Col>
                                    </Row>

                                    {modalMode === 'audit' && (
                                        <Card title="审核操作">
                                            <Form form={auditForm} layout="vertical">
                                                <Form.Item name="result" label="审核结果" rules={[{ required: true }]}>
                                                    <Radio.Group>
                                                        <Radio value="pass">确认，可入库</Radio>
                                                        <Radio value="fail">退回，重新修改</Radio>
                                                    </Radio.Group>
                                                </Form.Item>
                                                <Form.Item
                                                    noStyle
                                                    shouldUpdate={(prevValues, currentValues) =>
                                                        prevValues.result !== currentValues.result
                                                    }
                                                >
                                                    {({ getFieldValue }) =>
                                                        getFieldValue('result') === 'fail' ? (
                                                            <Form.Item
                                                                name="reason"
                                                                label="审核意见"
                                                                rules={[{ required: true, message: '请填写退回理由' }]}
                                                            >
                                                                <Input.TextArea
                                                                    rows={4}
                                                                    placeholder="请详细说明退回的具体原因..."
                                                                />
                                                            </Form.Item>
                                                        ) : null
                                                    }
                                                </Form.Item>
                                            </Form>
                                        </Card>
                                    )}

                                    {modalMode === 'view' && (
                                        <Card title="审核历史">
                                            <Timeline>
                                                {selectedTask.auditHistory?.map((item, index) => (
                                                    <Timeline.Item key={index}>
                                                        <p>
                                                            {item.time} - {item.user}
                                                        </p>
                                                        <p>
                                                            <Tag color={item.action.includes('退回') ? 'red' : 'green'}>
                                                                {item.action}
                                                            </Tag>{' '}
                                                            {item.content}
                                                        </p>
                                                    </Timeline.Item>
                                                ))}
                                            </Timeline>
                                        </Card>
                                    )}
                                </div>
                            )}
                        </Modal>
                    </Card>
                );
            };

            // --- 5. 协议跟踪报表 ---
            const TrackingReport = () => {
                const [selectedProjects, setSelectedProjects] = useState([]);
                const [reportData, setReportData] = useState([]);
                const [columns, setColumns] = useState([]);
                const [isModalVisible, setIsModalVisible] = useState(false);
                const [selectedColumns, setSelectedColumns] = useLocalStorage('reportColumns', [
                    'projectName',
                    'indicatorName',
                    'targetValue',
                    'status',
                ]);
                const [templates, setTemplates] = useLocalStorage('reportTemplates', {
                    默认模板: ['projectName', 'indicatorName', 'targetValue', 'status'],
                });
                const [newTemplateName, setNewTemplateName] = useState('');

                const allProjects = MOCK_DB.projects;
                const projectDetails = MOCK_DB.projectDetails;
                const allTasks = MOCK_DB.kanbanTasks;

                const allColumnOptions = [
                    {
                        label: '项目基本信息',
                        value: 'group-basic',
                        children: [
                            { label: '项目名称', value: 'projectName' },
                            { label: '项目公司', value: 'projectCompany' },
                            { label: '招商单位', value: 'unit' },
                            { label: '招商经理', value: 'manager' },
                        ],
                    },
                    {
                        label: '企业指标详情',
                        value: 'group-indicator',
                        children: [
                            { label: '指标名称', value: 'indicatorName' },
                            { label: '约定目标', value: 'targetValue' },
                            { label: '实际完成情况', value: 'completedValue' },
                            { label: '履约状态', value: 'status' },
                        ],
                    },
                    {
                        label: '政策兑现详情',
                        value: 'group-policy',
                        children: [
                            { label: '政策名称', value: 'policyName' },
                            { label: '政策状态', value: 'policyStatus' },
                        ],
                    },
                    {
                        label: '履约过程记录',
                        value: 'group-history',
                        children: [{ label: '履约历史', value: 'history' }],
                    },
                ];

                const columnMap = {
                    projectName: { title: '项目名称', dataIndex: 'projectName', key: 'projectName' },
                    projectCompany: { title: '项目公司', dataIndex: 'projectCompany', key: 'projectCompany' },
                    unit: { title: '招商单位', dataIndex: 'unit', key: 'unit' },
                    manager: { title: '招商经理', dataIndex: 'manager', key: 'manager' },
                    indicatorName: { title: '指标名称', dataIndex: 'indicatorName', key: 'indicatorName' },
                    targetValue: { title: '约定目标', dataIndex: 'targetValue', key: 'targetValue' },
                    completedValue: { title: '实际完成情况', dataIndex: 'completedValue', key: 'completedValue' },
                    status: {
                        title: '履约状态',
                        dataIndex: 'status',
                        key: 'status',
                        render: status => <Tag>{status}</Tag>,
                    },
                    policyName: { title: '政策名称', dataIndex: 'policyName', key: 'policyName' },
                    policyStatus: { title: '政策状态', dataIndex: 'policyStatus', key: 'policyStatus' },
                    history: {
                        title: '履约历史',
                        dataIndex: 'history',
                        key: 'history',
                        render: history => <div style={{ maxWidth: 300, whiteSpace: 'pre-wrap' }}>{history}</div>,
                    },
                };

                const generateReport = () => {
                    if (selectedProjects.length === 0) {
                        message.warning('请至少选择一个项目');
                        return;
                    }

                    let data = [];
                    selectedProjects.forEach(projectId => {
                        const projectInfo = projectDetails[projectId];
                        if (!projectInfo) return;

                        const baseInfo = {
                            key: `proj-${projectId}`,
                            projectName: projectInfo.name,
                            projectCompany: projectInfo.companies?.[0]?.name,
                            unit: projectInfo.unit,
                            manager: projectInfo.manager,
                        };

                        // Indicators
                        (projectInfo.indicators || []).forEach((indicatorGroup, index) => {
                            (indicatorGroup.items || []).forEach((indicator, itemIndex) => {
                                const task =
                                    allTasks.find(
                                        t => t.projectName === projectInfo.name && t.indicatorName === indicator.name
                                    ) || {};
                                data.push({
                                    ...baseInfo,
                                    key: `ind-${projectId}-${index}-${itemIndex}`,
                                    indicatorName: indicator.name,
                                    targetValue: indicator.target,
                                    completedValue: task.completedValue,
                                    status: indicator.status,
                                    history:
                                        task.auditHistory
                                            ?.map(h => `${h.time} ${h.user} [${h.action}]: ${h.content}`)
                                            .join('\n') || '',
                                });
                            });
                        });

                        // Policies
                        (projectInfo.policies || []).forEach((policy, index) => {
                            data.push({
                                ...baseInfo,
                                key: `pol-${projectId}-${index}`,
                                policyName: policy.title,
                                policyStatus: policy.children?.[0]?.status || '未知',
                            });
                        });
                    });

                    setReportData(data);
                    const activeColumns = selectedColumns.map(key => columnMap[key]).filter(Boolean);
                    setColumns(activeColumns);
                };

                const handleSaveTemplate = () => {
                    if (!newTemplateName) {
                        message.error('请输入模板名称');
                        return;
                    }
                    const newTemplates = { ...templates, [newTemplateName]: selectedColumns };
                    setTemplates(newTemplates);
                    message.success('模板保存成功');
                    setNewTemplateName('');
                };

                const handleLoadTemplate = templateName => {
                    setSelectedColumns(templates[templateName]);
                };

                const exportToCsv = () => {
                    if (reportData.length === 0) {
                        message.warning('请先生成报告');
                        return;
                    }
                    const headers = columns.map(c => c.title).join(',');
                    const rows = reportData.map(row => {
                        return columns
                            .map(col => {
                                let cellData = row[col.dataIndex] || '';
                                if (typeof cellData === 'string') {
                                    return `"${cellData.replace(/"/g, '""')}"`;
                                }
                                return `"${cellData}"`;
                            })
                            .join(',');
                    });

                    const csvContent = 'data:text/csv;charset=utf-8,' + [headers, ...rows].join('\n');
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', '协议跟踪报表.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                return (
                    <Card title="协议跟踪报表">
                        <Space style={{ marginBottom: 16 }}>
                            <Select
                                mode="multiple"
                                placeholder="请选择要生成报告的项目"
                                value={selectedProjects}
                                onChange={setSelectedProjects}
                                style={{ width: 400 }}
                                options={allProjects.map(p => ({ label: p.name, value: p.id }))}
                            />
                            <Button type="primary" onClick={generateReport}>
                                生成报告
                            </Button>
                            <Button icon={<SettingOutlined />} onClick={() => setIsModalVisible(true)}>
                                自定义导出列
                            </Button>
                            <Button icon={<DownloadOutlined />} onClick={exportToCsv}>
                                导出报表 (CSV)
                            </Button>
                        </Space>

                        <Table
                            columns={columns}
                            dataSource={reportData}
                            bordered
                            size="small"
                            scroll={{ x: 'max-content' }}
                        />

                        <Modal
                            title="自定义导出列"
                            open={isModalVisible}
                            onOk={() => {
                                generateReport();
                                setIsModalVisible(false);
                            }}
                            onCancel={() => setIsModalVisible(false)}
                            width={600}
                        >
                            <Checkbox.Group
                                style={{ width: '100%' }}
                                value={selectedColumns}
                                onChange={setSelectedColumns}
                            >
                                {allColumnOptions.map(group => (
                                    <div key={group.value}>
                                        <Divider orientation="left">{group.label}</Divider>
                                        <Row>
                                            {group.children.map(option => (
                                                <Col span={8} key={option.value}>
                                                    <Checkbox value={option.value}>{option.label}</Checkbox>
                                                </Col>
                                            ))}
                                        </Row>
                                    </div>
                                ))}
                            </Checkbox.Group>
                            <Divider />
                            <Space>
                                <Input
                                    placeholder="输入新模板名称"
                                    value={newTemplateName}
                                    onChange={e => setNewTemplateName(e.target.value)}
                                />
                                <Button icon={<SaveOutlined />} onClick={handleSaveTemplate}>
                                    保存为模板
                                </Button>
                                <Select placeholder="加载模板" onChange={handleLoadTemplate} style={{ width: 150 }}>
                                    {Object.keys(templates).map(name => (
                                        <Select.Option key={name} value={name}>
                                            {name}
                                        </Select.Option>
                                    ))}
                                </Select>
                            </Space>
                        </Modal>
                    </Card>
                );
            };

            // --- 6. 履约全景看板 (新增) ---
            const EchartsRadar = ({ option }) => {
                const chartRef = useRef(null);

                useEffect(() => {
                    const chart = echarts.init(chartRef.current);
                    chart.setOption(option);

                    const handleResize = () => chart.resize();
                    window.addEventListener('resize', handleResize);

                    return () => {
                        window.removeEventListener('resize', handleResize);
                        chart.dispose();
                    };
                }, [option]);

                return <div ref={chartRef} style={{ width: '100%', height: '400px' }} />;
            };

            const PanoramicDashboard = ({ setActiveTab }) => {
                const [tasks] = useLocalStorage('kanbanTasks', MOCK_DB.kanbanTasks);
                const [projects] = useLocalStorage('projects', MOCK_DB.projects);
                const [policies] = useLocalStorage('enterprisePolicies', MOCK_DB.enterprisePolicies);

                const totalEnterprises = new Set(tasks.map(t => t.projectCompany)).size;
                const totalAgreements = projects.length;
                const overdueTasks = tasks.filter(t => t.status === '已逾期').length;
                const pendingPolicies = policies.unlocked.filter(p => p.status === '待申请').length;

                const now = dayjs();
                const pendingThisMonth = tasks.filter(t => {
                    const dueDate = dayjs(t.dueDate);
                    return t.status === '进行中' && dueDate.isSame(now, 'month');
                }).length;

                const radarOption = {
                    title: { text: '协议健康度雷达图' },
                    tooltip: {},
                    legend: {
                        data: ['AI芯片项目', '新能源项目', '生物医药项目'],
                    },
                    radar: {
                        indicator: [
                            { name: '资金到位率', max: 100 },
                            { name: '关键指标完成率', max: 100 },
                            { name: '沟通活跃度', max: 100 },
                            { name: '风险预警数', max: 10 },
                        ],
                    },
                    series: [
                        {
                            name: '协议健康度',
                            type: 'radar',
                            data: [
                                { value: [95, 80, 88, 2], name: 'AI芯片项目' },
                                { value: [80, 75, 70, 4], name: '新能源项目' },
                                { value: [60, 85, 95, 8], name: '生物医药项目' },
                            ],
                        },
                    ],
                };

                const riskData = tasks
                    .filter(t => t.status === '已逾期')
                    .map(
                        t =>
                            `“${t.projectCompany}”的《${t.indicatorName}》指标已逾期${dayjs().diff(
                                dayjs(t.dueDate),
                                'day'
                            )}天`
                    );

                return (
                    <div>
                        <Row gutter={[16, 16]}>
                            <Col span={4}>
                                <Card hoverable className="statistic-card">
                                    <Statistic title="在管企业总数" value={totalEnterprises} />
                                </Card>
                            </Col>
                            <Col span={5}>
                                <Card hoverable className="statistic-card">
                                    <Statistic title="有效协议总数" value={totalAgreements} />
                                </Card>
                            </Col>
                            <Col span={5}>
                                <Card
                                    hoverable
                                    className="statistic-card"
                                    onClick={() => {
                                        message.info('正在跳转到看板...');
                                        setActiveTab('3');
                                    }}
                                >
                                    <Statistic title="本月待跟进指标" value={pendingThisMonth} />
                                </Card>
                            </Col>
                            <Col span={5}>
                                <Card hoverable className="statistic-card">
                                    <Statistic title="已达标待兑现政策" value={pendingPolicies} />
                                </Card>
                            </Col>
                            <Col span={5}>
                                <Card
                                    hoverable
                                    className="statistic-card"
                                    onClick={() => {
                                        message.info('正在跳转到看板...');
                                        setActiveTab('3');
                                    }}
                                >
                                    <Statistic
                                        title="红色预警(逾期)指标"
                                        value={overdueTasks}
                                        valueStyle={{ color: '#cf1322' }}
                                        prefix={<WarningOutlined />}
                                    />
                                </Card>
                            </Col>
                        </Row>
                        <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
                            <Col span={16}>
                                <Card>
                                    <EchartsRadar option={radarOption} />
                                </Card>
                            </Col>
                            <Col span={8}>
                                <Card title="风险预警" style={{ height: '100%' }}>
                                    <List
                                        dataSource={riskData}
                                        renderItem={item => (
                                            <List.Item>
                                                <Typography.Text type="danger">
                                                    <WarningOutlined /> {item}
                                                </Typography.Text>
                                            </List.Item>
                                        )}
                                    />
                                </Card>
                            </Col>
                        </Row>
                    </div>
                );
            };

            // --- 7. 企业驾驶舱 (企业端) ---
            const EchartsLine = ({ option }) => {
                const chartRef = useRef(null);
                useEffect(() => {
                    if (chartRef.current) {
                        let chart = echarts.getInstanceByDom(chartRef.current);
                        if (!chart) {
                            chart = echarts.init(chartRef.current);
                        }
                        chart.setOption(option, true);
                        const handleResize = () => chart.resize();
                        window.addEventListener('resize', handleResize);
                        return () => {
                            window.removeEventListener('resize', handleResize);
                            chart.dispose();
                        };
                    }
                }, [option]);
                return <div ref={chartRef} style={{ width: '100%', height: '300px' }} />;
            };

            const EnterprisePage = () => {
                const [dataForm] = Form.useForm();
                const [businessData, setBusinessData] = useLocalStorage(
                    'enterpriseBusinessData',
                    MOCK_DB.enterpriseBusinessData
                );
                const [projectDetails, setProjectDetails] = useLocalStorage('projectDetails', MOCK_DB.projectDetails);
                const [isDataModalVisible, setIsDataModalVisible] = useState(false);
                const [isHistoryModalVisible, setIsHistoryModalVisible] = useState(false);
                const [selectedHistoryItem, setSelectedHistoryItem] = useState(null);

                const [indicators, setIndicators] = useLocalStorage(
                    'enterpriseIndicators',
                    MOCK_DB.enterpriseIndicators
                );
                const [isIndicatorUpdateModalVisible, setIsIndicatorUpdateModalVisible] = useState(false);
                const [currentIndicator, setCurrentIndicator] = useState(null);
                const [isViewFeedbackModalVisible, setIsViewFeedbackModalVisible] = useState(false);
                const [currentFeedbackHistory, setCurrentFeedbackHistory] = useState(null);

                const [policyViewMode, setPolicyViewMode] = useState('list');
                const [businessViewMode, setBusinessViewMode] = useState('chart');

                const enterprisePolicyPlans = useMemo(() => {
                    const plans = {};
                    const companyProject = MOCK_DB.projectDetails['1']; // Assuming project 1 for demo company
                    if (companyProject && companyProject.policies) {
                        companyProject.policies.forEach(policyCategory => {
                            (policyCategory.children || []).forEach(item => {
                                if (!plans[item.year]) {
                                    plans[item.year] = [];
                                }
                                plans[item.year].push(item);
                            });
                        });
                    }
                    return plans;
                }, [projectDetails]);

                const availablePolicyYears = Object.keys(enterprisePolicyPlans).sort((a, b) => b - a);
                const [selectedPolicyYear, setSelectedPolicyYear] = useState(
                    availablePolicyYears[0] || dayjs().format('YYYY')
                );

                const indicatorsByYear = useMemo(() => {
                    return indicators.reduce((acc, indicator) => {
                        const year = indicator.period.substring(0, 4);
                        if (!acc[year]) {
                            acc[year] = [];
                        }
                        acc[year].push(indicator);
                        return acc;
                    }, {});
                }, [indicators]);

                const availableIndicatorYears = Object.keys(indicatorsByYear).sort((a, b) => b - a);
                const [selectedIndicatorYear, setSelectedIndicatorYear] = useState(
                    availableIndicatorYears[0] || dayjs().format('YYYY')
                );

                const allPolicies = Object.values(projectDetails).flatMap(p => p.policies || []);
                const flattenedPolicies = allPolicies.flatMap(p =>
                    (p.children || []).map(c => ({
                        label: `${p.title} (${c.title})`,
                        value: c.key,
                    }))
                );

                const handleFormSubmit = values => {
                    const year = values.year.format('YYYY');
                    const existingEntry = businessData.find(d => d.year === year && d.company === '芯智科技有限公司');
                    if (existingEntry && (existingEntry.status === '已审核' || existingEntry.status === '待审核')) {
                        message.warning(`${year}年度的数据已提交或已审核，无法重复提交。`);
                        return;
                    }

                    const newSubmission = {
                        id: Date.now(),
                        company: '芯智科技有限公司',
                        year: year,
                        status: '待审核',
                        submissionTime: dayjs().format('YYYY-MM-DD'),
                        revenue: { value: values.revenue, files: values.revenue_files?.fileList },
                        tax: { value: values.tax, files: values.tax_files?.fileList },
                        fixedInvestment: {
                            value: values.fixedInvestment,
                            files: values.fixedInvestment_files?.fileList,
                        },
                        outputValue: { value: values.outputValue, files: values.outputValue_files?.fileList },
                        rdInvestment: { value: values.rdInvestment, files: values.rdInvestment_files?.fileList },
                        policyPlans: values.policyPlans
                            ? values.policyPlans.map(p => ({
                                  ...p,
                                  policyName: flattenedPolicies.find(opt => opt.value === p.policyKey)?.label,
                              }))
                            : [],
                    };

                    setBusinessData(currentData => [
                        ...currentData.filter(d => d.id !== existingEntry?.id),
                        newSubmission,
                    ]);
                    message.success(`${year}年度经营情况提交成功，请等待审核。`);
                    setIsDataModalVisible(false);
                    dataForm.resetFields();
                };

                const showHistoryModal = record => {
                    setSelectedHistoryItem(record);
                    setIsHistoryModalVisible(true);
                };

                const showIndicatorUpdateModal = indicator => {
                    setCurrentIndicator(indicator);
                    setIsIndicatorUpdateModalVisible(true);
                };

                const showViewFeedbackModal = history => {
                    setCurrentFeedbackHistory(history);
                    setIsViewFeedbackModalVisible(true);
                };

                const handleIndicatorUpdate = () => {
                    message.success('提交审核成功！');
                    setIndicators(
                        indicators.map(ind => (ind.id === currentIndicator.id ? { ...ind, status: '待审核' } : ind))
                    );
                    setIsIndicatorUpdateModalVisible(false);
                };

                const policyDataByYear = useMemo(() => {
                    const policyData = {};
                    const companyPolicies = projectDetails['1']?.policies || [];
                    companyPolicies.forEach(policy => {
                        (policy.children || []).forEach(child => {
                            if (child.status === '已兑现' && child.year && child.approvedAmount) {
                                if (!policyData[child.year]) {
                                    policyData[child.year] = { count: 0, amount: 0 };
                                }
                                policyData[child.year].count += 1;
                                policyData[child.year].amount += child.approvedAmount;
                            }
                        });
                    });
                    return policyData;
                }, [projectDetails]);

                const auditedData = businessData
                    .filter(d => d.status === '已审核' && d.company === '芯智科技有限公司')
                    .sort((a, b) => parseInt(a.year) - parseInt(b.year));

                const chartData = auditedData.map(d => ({
                    ...d,
                    policyCount: policyDataByYear[d.year]?.count || 0,
                    policyAmount: policyDataByYear[d.year]?.amount || 0,
                }));

                const businessChartOption = {
                    title: { text: '历年经营数据趋势', textStyle: { fontSize: 16 } },
                    tooltip: { trigger: 'axis' },
                    legend: {
                        data: ['营收', '税收', '固投', '产值', '研发投入'],
                        top: 25,
                    },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', boundaryGap: false, data: chartData.map(d => d.year) },
                    yAxis: {
                        type: 'value',
                        name: '金额 (元)',
                        axisLabel: { formatter: value => `${value / 10000} 万` },
                    },
                    series: [
                        { name: '营收', type: 'line', data: chartData.map(d => d.revenue.value) },
                        { name: '税收', type: 'line', data: chartData.map(d => d.tax.value) },
                        { name: '固投', type: 'line', data: chartData.map(d => d.fixedInvestment.value) },
                        { name: '产值', type: 'line', data: chartData.map(d => d.outputValue.value) },
                        { name: '研发投入', type: 'line', data: chartData.map(d => d.rdInvestment.value) },
                    ],
                };

                const policyChartOption = {
                    title: { text: '历年政策兑现趋势', textStyle: { fontSize: 16 } },
                    tooltip: { trigger: 'axis' },
                    legend: {
                        data: ['兑现补贴金额', '兑现政策数'],
                        top: 25,
                    },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', boundaryGap: false, data: chartData.map(d => d.year) },
                    yAxis: [
                        {
                            type: 'value',
                            name: '金额 (元)',
                            axisLabel: { formatter: value => `${value / 10000} 万` },
                        },
                        {
                            type: 'value',
                            name: '数量 (个)',
                            min: 0,
                            axisLabel: { formatter: '{value} 个' },
                        },
                    ],
                    series: [
                        { name: '兑现补贴金额', type: 'line', data: chartData.map(d => d.policyAmount) },
                        { name: '兑现政策数', type: 'bar', yAxisIndex: 1, data: chartData.map(d => d.policyCount) },
                    ],
                };

                const historyColumns = [
                    { title: '填报年度', dataIndex: 'year', key: 'year' },
                    { title: '提交时间', dataIndex: 'submissionTime', key: 'submissionTime' },
                    {
                        title: '状态',
                        dataIndex: 'status',
                        key: 'status',
                        render: status => {
                            let color = 'default';
                            if (status === '已审核') color = 'success';
                            if (status === '待审核') color = 'warning';
                            if (status === '已驳回') color = 'error';
                            return <Tag color={color}>{status}</Tag>;
                        },
                    },
                    {
                        title: '操作',
                        key: 'action',
                        render: (_, record) => (
                            <Button type="link" onClick={() => showHistoryModal(record)}>
                                查看详情
                            </Button>
                        ),
                    },
                ];

                const hasBusinessData = businessData.some(d => d.company === '芯智科技有限公司');

                if (!hasBusinessData) {
                    return (
                        <Card>
                            <Result
                                icon={<SolutionOutlined />}
                                title="欢迎使用一企一策管理平台"
                                subTitle="请先提交您企业上一年度的经营情况，以便我们为您提供精准的政策服务和履约跟踪。"
                                extra={
                                    <Button type="primary" onClick={() => setIsDataModalVisible(true)}>
                                        首次填报经营数据
                                    </Button>
                                }
                            />
                            <Modal
                                title="填报年度经营数据"
                                open={isDataModalVisible}
                                onOk={() => dataForm.submit()}
                                onCancel={() => setIsDataModalVisible(false)}
                                width={600}
                                okText="提交"
                                cancelText="取消"
                            >
                                <Form form={dataForm} layout="vertical" onFinish={handleFormSubmit}>
                                    <Form.Item name="year" label="填报年度" rules={[{ required: true }]}>
                                        <DatePicker picker="year" style={{ width: '100%' }} />
                                    </Form.Item>
                                    <Form.Item label="营收" required>
                                        <Space.Compact style={{ width: '100%' }}>
                                            <Form.Item name="revenue" noStyle rules={[{ required: true }]}>
                                                <InputNumber
                                                    addonAfter="元"
                                                    style={{ width: '70%' }}
                                                    formatter={value =>
                                                        `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                                                    }
                                                    parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                                />
                                            </Form.Item>
                                            <Form.Item name="revenue_files" noStyle rules={[{ required: true }]}>
                                                <Upload beforeUpload={() => false} maxCount={1}>
                                                    <Button icon={<UploadOutlined />}>上传附件</Button>
                                                </Upload>
                                            </Form.Item>
                                        </Space.Compact>
                                    </Form.Item>
                                    <Form.Item label="税收" required>
                                        <Space.Compact style={{ width: '100%' }}>
                                            <Form.Item name="tax" noStyle rules={[{ required: true }]}>
                                                <InputNumber
                                                    addonAfter="元"
                                                    style={{ width: '70%' }}
                                                    formatter={value =>
                                                        `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                                                    }
                                                    parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                                />
                                            </Form.Item>
                                            <Form.Item name="tax_files" noStyle rules={[{ required: true }]}>
                                                <Upload beforeUpload={() => false} maxCount={1}>
                                                    <Button icon={<UploadOutlined />}>上传附件</Button>
                                                </Upload>
                                            </Form.Item>
                                        </Space.Compact>
                                    </Form.Item>
                                    <Form.Item label="固投" required>
                                        <Space.Compact style={{ width: '100%' }}>
                                            <Form.Item name="fixedInvestment" noStyle rules={[{ required: true }]}>
                                                <InputNumber
                                                    addonAfter="元"
                                                    style={{ width: '70%' }}
                                                    formatter={value =>
                                                        `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                                                    }
                                                    parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                                />
                                            </Form.Item>
                                            <Form.Item
                                                name="fixedInvestment_files"
                                                noStyle
                                                rules={[{ required: true }]}
                                            >
                                                <Upload beforeUpload={() => false} maxCount={1}>
                                                    <Button icon={<UploadOutlined />}>上传附件</Button>
                                                </Upload>
                                            </Form.Item>
                                        </Space.Compact>
                                    </Form.Item>
                                    <Form.Item label="产值" required>
                                        <Space.Compact style={{ width: '100%' }}>
                                            <Form.Item name="outputValue" noStyle rules={[{ required: true }]}>
                                                <InputNumber
                                                    addonAfter="元"
                                                    style={{ width: '70%' }}
                                                    formatter={value =>
                                                        `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                                                    }
                                                    parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                                />
                                            </Form.Item>
                                            <Form.Item name="outputValue_files" noStyle rules={[{ required: true }]}>
                                                <Upload beforeUpload={() => false} maxCount={1}>
                                                    <Button icon={<UploadOutlined />}>上传附件</Button>
                                                </Upload>
                                            </Form.Item>
                                        </Space.Compact>
                                    </Form.Item>
                                    <Form.Item label="研发投入" required>
                                        <Space.Compact style={{ width: '100%' }}>
                                            <Form.Item name="rdInvestment" noStyle rules={[{ required: true }]}>
                                                <InputNumber
                                                    addonAfter="元"
                                                    style={{ width: '70%' }}
                                                    formatter={value =>
                                                        `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                                                    }
                                                    parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                                />
                                            </Form.Item>
                                            <Form.Item name="rdInvestment_files" noStyle rules={[{ required: true }]}>
                                                <Upload beforeUpload={() => false} maxCount={1}>
                                                    <Button icon={<UploadOutlined />}>上传附件</Button>
                                                </Upload>
                                            </Form.Item>
                                        </Space.Compact>
                                    </Form.Item>
                                    <Divider>本年度拟兑现政策和预算</Divider>
                                    <Form.List name="policyPlans">
                                        {(fields, { add, remove }) => (
                                            <>
                                                {fields.map(({ key, name, ...restField }) => (
                                                    <Space
                                                        key={key}
                                                        style={{ display: 'flex', marginBottom: 8 }}
                                                        align="baseline"
                                                    >
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'policyKey']}
                                                            rules={[{ required: true }]}
                                                        >
                                                            <Select
                                                                options={flattenedPolicies}
                                                                placeholder="选择拟兑现政策"
                                                                style={{ width: 300 }}
                                                            />
                                                        </Form.Item>
                                                        <Form.Item
                                                            {...restField}
                                                            name={[name, 'budget']}
                                                            rules={[{ required: true }]}
                                                        >
                                                            <InputNumber
                                                                addonAfter="元"
                                                                placeholder="拟兑现金额"
                                                                style={{ width: 180 }}
                                                                formatter={value =>
                                                                    `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                                                                }
                                                                parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                                            />
                                                        </Form.Item>
                                                        <DeleteOutlined onClick={() => remove(name)} />
                                                    </Space>
                                                ))}
                                                <Form.Item>
                                                    <Button
                                                        type="dashed"
                                                        onClick={() => add()}
                                                        block
                                                        icon={<PlusOutlined />}
                                                    >
                                                        添加政策计划
                                                    </Button>
                                                </Form.Item>
                                            </>
                                        )}
                                    </Form.List>
                                </Form>
                            </Modal>
                        </Card>
                    );
                }

                return (
                    <Space direction="vertical" size="large" style={{ display: 'flex' }}>
                        <Card
                            title="企业经营发展"
                            extra={
                                <Space>
                                    <Segmented
                                        options={[
                                            { label: '趋势图', value: 'chart' },
                                            { label: '列表', value: 'list' },
                                        ]}
                                        value={businessViewMode}
                                        onChange={setBusinessViewMode}
                                    />
                                    <Button type="primary" onClick={() => setIsDataModalVisible(true)}>
                                        新增/修改年度数据
                                    </Button>
                                </Space>
                            }
                        >
                            {businessViewMode === 'chart' ? (
                                auditedData.length > 0 ? (
                                    <Row gutter={16}>
                                        <Col span={24}>
                                            <EchartsLine option={businessChartOption} />
                                        </Col>
                                    </Row>
                                ) : (
                                    <Empty description="暂无已审核的历史数据可供分析" />
                                )
                            ) : (
                                <Table
                                    columns={historyColumns}
                                    dataSource={businessData
                                        .filter(d => d.company === '芯智科技有限公司')
                                        .sort((a, b) => parseInt(b.year) - parseInt(a.year))}
                                    rowKey="id"
                                    pagination={{ pageSize: 5 }}
                                />
                            )}
                        </Card>

                        <Card title="指标履约计划">
                            <Segmented
                                options={availableIndicatorYears}
                                value={selectedIndicatorYear}
                                onChange={setSelectedIndicatorYear}
                                style={{ marginBottom: '24px' }}
                            />
                            <Row gutter={[16, 16]}>
                                {(indicatorsByYear[selectedIndicatorYear] || []).map(ind => (
                                    <Col xs={24} sm={12} md={8} key={ind.id}>
                                        <Card>
                                            <p>
                                                <strong>{ind.name}</strong> ({ind.period})
                                            </p>
                                            <p>
                                                目标值: {ind.target} | 当前完成: {ind.current}
                                            </p>
                                            <Progress percent={ind.progress} />
                                            <div
                                                style={{
                                                    marginTop: 10,
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                }}
                                            >
                                                <Tag
                                                    color={
                                                        ind.status === '已确认'
                                                            ? 'green'
                                                            : ind.status === '待审核'
                                                            ? 'blue'
                                                            : ind.status === '待修改提交'
                                                            ? 'gold'
                                                            : 'default'
                                                    }
                                                >
                                                    {ind.status}
                                                </Tag>
                                                {ind.status === '进行中' || ind.status === '待修改提交' ? (
                                                    <Button
                                                        size="small"
                                                        type="primary"
                                                        onClick={() => showIndicatorUpdateModal(ind)}
                                                    >
                                                        更新进度
                                                    </Button>
                                                ) : (
                                                    <Button
                                                        size="small"
                                                        onClick={() => showViewFeedbackModal(ind.feedbackHistory)}
                                                    >
                                                        查看反馈
                                                    </Button>
                                                )}
                                            </div>
                                        </Card>
                                    </Col>
                                ))}
                                {(indicatorsByYear[selectedIndicatorYear] || []).length === 0 && (
                                    <Col span={24}>
                                        <Empty description={`暂无 ${selectedIndicatorYear} 年的指标计划`} />
                                    </Col>
                                )}
                            </Row>
                        </Card>

                        <Card
                            title="政策兑现计划"
                            extra={
                                <Segmented
                                    options={[
                                        { label: '列表', value: 'list' },
                                        { label: '趋势图', value: 'chart' },
                                    ]}
                                    value={policyViewMode}
                                    onChange={setPolicyViewMode}
                                />
                            }
                        >
                            {policyViewMode === 'list' ? (
                                <>
                                    <Select
                                        value={selectedPolicyYear}
                                        onChange={setSelectedPolicyYear}
                                        options={availablePolicyYears.map(year => ({
                                            label: `${year}年`,
                                            value: year,
                                        }))}
                                        style={{ width: 120, marginBottom: 16 }}
                                        placeholder="选择年度"
                                    />
                                    <Table
                                        dataSource={enterprisePolicyPlans[selectedPolicyYear] || []}
                                        rowKey="key"
                                        size="small"
                                        pagination={false}
                                        columns={[
                                            {
                                                title: '政策名称',
                                                dataIndex: 'title',
                                                key: 'title',
                                            },
                                            {
                                                title: '申报情况',
                                                dataIndex: 'status',
                                                key: 'apply',
                                                render: (status, record) => {
                                                    if (status === '待配置') {
                                                        return <Tag color="orange">未申报</Tag>;
                                                    }
                                                    return (
                                                        <div>
                                                            <Tag color="green">已申报</Tag>
                                                            <div style={{ fontSize: '12px', color: '#888' }}>
                                                                金额: {record.applyAmount?.toLocaleString()}元
                                                            </div>
                                                        </div>
                                                    );
                                                },
                                            },
                                            {
                                                title: '审批情况',
                                                dataIndex: 'status',
                                                key: 'approve',
                                                render: (status, record) => {
                                                    if (status === '待配置') {
                                                        return <Tag>待申报</Tag>;
                                                    }
                                                    if (status === '已申报待审批') {
                                                        return <Tag color="processing">审批中</Tag>;
                                                    }
                                                    if (status === '已兑现') {
                                                        return (
                                                            <div>
                                                                <Tag color="success">已批准</Tag>
                                                                <div style={{ fontSize: '12px', color: '#888' }}>
                                                                    金额: {record.approvedAmount?.toLocaleString()}元
                                                                </div>
                                                            </div>
                                                        );
                                                    }
                                                    return <Tag>{status}</Tag>;
                                                },
                                            },
                                            {
                                                title: '操作',
                                                key: 'action',
                                                render: (_, record) => {
                                                    if (record.status === '待配置') {
                                                        return (
                                                            <Button
                                                                type="primary"
                                                                size="small"
                                                                onClick={() =>
                                                                    message.info(`正在进入 ${record.title} 申报页面...`)
                                                                }
                                                            >
                                                                去申报
                                                            </Button>
                                                        );
                                                    }
                                                    return <Button size="small">查看</Button>;
                                                },
                                            },
                                        ]}
                                    />
                                </>
                            ) : auditedData.length > 0 ? (
                                <EchartsLine option={policyChartOption} />
                            ) : (
                                <Empty description="暂无已审核的历史数据可供分析" />
                            )}
                        </Card>

                        <Modal
                            title="填报年度经营数据"
                            open={isDataModalVisible}
                            onOk={() => dataForm.submit()}
                            onCancel={() => setIsDataModalVisible(false)}
                            width={600}
                            okText="提交"
                            cancelText="取消"
                        >
                            <Form form={dataForm} layout="vertical" onFinish={handleFormSubmit}>
                                <Form.Item name="year" label="填报年度" rules={[{ required: true }]}>
                                    <DatePicker picker="year" style={{ width: '100%' }} />
                                </Form.Item>
                                <Form.Item label="营收" required>
                                    <Space.Compact style={{ width: '100%' }}>
                                        <Form.Item name="revenue" noStyle rules={[{ required: true }]}>
                                            <InputNumber
                                                addonAfter="元"
                                                style={{ width: '70%' }}
                                                formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                            />
                                        </Form.Item>
                                        <Form.Item name="revenue_files" noStyle rules={[{ required: true }]}>
                                            <Upload beforeUpload={() => false} maxCount={1}>
                                                <Button icon={<UploadOutlined />}>上传附件</Button>
                                            </Upload>
                                        </Form.Item>
                                    </Space.Compact>
                                </Form.Item>
                                <Form.Item label="税收" required>
                                    <Space.Compact style={{ width: '100%' }}>
                                        <Form.Item name="tax" noStyle rules={[{ required: true }]}>
                                            <InputNumber
                                                addonAfter="元"
                                                style={{ width: '70%' }}
                                                formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                            />
                                        </Form.Item>
                                        <Form.Item name="tax_files" noStyle rules={[{ required: true }]}>
                                            <Upload beforeUpload={() => false} maxCount={1}>
                                                <Button icon={<UploadOutlined />}>上传附件</Button>
                                            </Upload>
                                        </Form.Item>
                                    </Space.Compact>
                                </Form.Item>
                                <Form.Item label="固投" required>
                                    <Space.Compact style={{ width: '100%' }}>
                                        <Form.Item name="fixedInvestment" noStyle rules={[{ required: true }]}>
                                            <InputNumber
                                                addonAfter="元"
                                                style={{ width: '70%' }}
                                                formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                            />
                                        </Form.Item>
                                        <Form.Item name="fixedInvestment_files" noStyle rules={[{ required: true }]}>
                                            <Upload beforeUpload={() => false} maxCount={1}>
                                                <Button icon={<UploadOutlined />}>上传附件</Button>
                                            </Upload>
                                        </Form.Item>
                                    </Space.Compact>
                                </Form.Item>
                                <Form.Item label="产值" required>
                                    <Space.Compact style={{ width: '100%' }}>
                                        <Form.Item name="outputValue" noStyle rules={[{ required: true }]}>
                                            <InputNumber
                                                addonAfter="元"
                                                style={{ width: '70%' }}
                                                formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                            />
                                        </Form.Item>
                                        <Form.Item name="outputValue_files" noStyle rules={[{ required: true }]}>
                                            <Upload beforeUpload={() => false} maxCount={1}>
                                                <Button icon={<UploadOutlined />}>上传附件</Button>
                                            </Upload>
                                        </Form.Item>
                                    </Space.Compact>
                                </Form.Item>
                                <Form.Item label="研发投入" required>
                                    <Space.Compact style={{ width: '100%' }}>
                                        <Form.Item name="rdInvestment" noStyle rules={[{ required: true }]}>
                                            <InputNumber
                                                addonAfter="元"
                                                style={{ width: '70%' }}
                                                formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                            />
                                        </Form.Item>
                                        <Form.Item name="rdInvestment_files" noStyle rules={[{ required: true }]}>
                                            <Upload beforeUpload={() => false} maxCount={1}>
                                                <Button icon={<UploadOutlined />}>上传附件</Button>
                                            </Upload>
                                        </Form.Item>
                                    </Space.Compact>
                                </Form.Item>
                                <Divider>本年度拟兑现政策和预算</Divider>
                                <Form.List name="policyPlans">
                                    {(fields, { add, remove }) => (
                                        <>
                                            {fields.map(({ key, name, ...restField }) => (
                                                <Space
                                                    key={key}
                                                    style={{ display: 'flex', marginBottom: 8 }}
                                                    align="baseline"
                                                >
                                                    <Form.Item
                                                        {...restField}
                                                        name={[name, 'policyKey']}
                                                        rules={[{ required: true }]}
                                                    >
                                                        <Select
                                                            options={flattenedPolicies}
                                                            placeholder="选择拟兑现政策"
                                                            style={{ width: 300 }}
                                                        />
                                                    </Form.Item>
                                                    <Form.Item
                                                        {...restField}
                                                        name={[name, 'budget']}
                                                        rules={[{ required: true }]}
                                                    >
                                                        <InputNumber
                                                            addonAfter="元"
                                                            placeholder="拟兑现金额"
                                                            style={{ width: 180 }}
                                                            formatter={value =>
                                                                `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                                                            }
                                                            parser={value => value.replace(/\$\s?|(,*)/g, '')}
                                                        />
                                                    </Form.Item>
                                                    <DeleteOutlined onClick={() => remove(name)} />
                                                </Space>
                                            ))}
                                            <Form.Item>
                                                <Button
                                                    type="dashed"
                                                    onClick={() => add()}
                                                    block
                                                    icon={<PlusOutlined />}
                                                >
                                                    添加政策计划
                                                </Button>
                                            </Form.Item>
                                        </>
                                    )}
                                </Form.List>
                            </Form>
                        </Modal>
                        <Modal
                            title="经营情况详情"
                            open={isHistoryModalVisible}
                            onCancel={() => setIsHistoryModalVisible(false)}
                            footer={[
                                <Button key="close" onClick={() => setIsHistoryModalVisible(false)}>
                                    关闭
                                </Button>,
                            ]}
                            width={800}
                        >
                            {selectedHistoryItem && (
                                <>
                                    <Descriptions bordered column={1} size="small">
                                        <Descriptions.Item label="企业名称">
                                            {selectedHistoryItem.company}
                                        </Descriptions.Item>
                                        <Descriptions.Item label="填报年度">
                                            {selectedHistoryItem.year}
                                        </Descriptions.Item>
                                        <Descriptions.Item label="营收">
                                            {selectedHistoryItem.revenue.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedHistoryItem.revenue.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="税收">
                                            {selectedHistoryItem.tax.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedHistoryItem.tax.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="固投">
                                            {selectedHistoryItem.fixedInvestment.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedHistoryItem.fixedInvestment.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="产值">
                                            {selectedHistoryItem.outputValue.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedHistoryItem.outputValue.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="研发投入">
                                            {selectedHistoryItem.rdInvestment.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedHistoryItem.rdInvestment.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        {selectedHistoryItem.auditComments && (
                                            <Descriptions.Item label="审核意见">
                                                {selectedHistoryItem.auditComments}
                                            </Descriptions.Item>
                                        )}
                                    </Descriptions>
                                    <Divider>拟兑现政策计划</Divider>
                                    <Table
                                        size="small"
                                        pagination={false}
                                        dataSource={selectedHistoryItem.policyPlans}
                                        rowKey="policyKey"
                                        columns={[
                                            { title: '政策名称', dataIndex: 'policyName' },
                                            {
                                                title: '拟兑现金额(元)',
                                                dataIndex: 'budget',
                                                render: val => val?.toLocaleString(),
                                            },
                                        ]}
                                    />
                                </>
                            )}
                        </Modal>
                        <Modal
                            title="更新指标进度"
                            open={isIndicatorUpdateModalVisible}
                            onOk={handleIndicatorUpdate}
                            onCancel={() => setIsIndicatorUpdateModalVisible(false)}
                        >
                            {currentIndicator && (
                                <Form layout="vertical">
                                    <p>
                                        <strong>指标名称:</strong> {currentIndicator.name}
                                    </p>
                                    <p>
                                        <strong>目标值:</strong> {currentIndicator.target}
                                    </p>
                                    <Form.Item label="当前完成值" required>
                                        <Input />
                                    </Form.Item>
                                    <Form.Item label="佐证材料" required>
                                        <Upload beforeUpload={() => false}>
                                            <Button icon={<UploadOutlined />}>上传文件</Button>
                                        </Upload>
                                    </Form.Item>
                                    <Form.Item label="备注说明">
                                        <Input.TextArea />
                                    </Form.Item>
                                </Form>
                            )}
                        </Modal>
                        <Modal
                            title="反馈历史"
                            open={isViewFeedbackModalVisible}
                            onCancel={() => setIsViewFeedbackModalVisible(false)}
                            footer={[
                                <Button key="close" onClick={() => setIsViewFeedbackModalVisible(false)}>
                                    关闭
                                </Button>,
                            ]}
                        >
                            <Timeline>
                                {currentFeedbackHistory && currentFeedbackHistory.length > 0 ? (
                                    currentFeedbackHistory.map((fb, index) => (
                                        <Timeline.Item key={index}>
                                            <p>
                                                <strong>{fb.date || fb.time}</strong>
                                            </p>
                                            <p>{fb.content}</p>
                                            {fb.files && (
                                                <Upload
                                                    fileList={fb.files}
                                                    disabled
                                                    itemRender={(originNode, file) => <a href="#">{file.name}</a>}
                                                />
                                            )}
                                        </Timeline.Item>
                                    ))
                                ) : (
                                    <Empty description="暂无反馈历史" />
                                )}
                            </Timeline>
                        </Modal>
                    </Space>
                );
            };

            // --- 10. 经营情况审核 (政务端) ---
            const BusinessDataAuditCenter = () => {
                const [businessData, setBusinessData] = useLocalStorage(
                    'enterpriseBusinessData',
                    MOCK_DB.enterpriseBusinessData
                );
                const [isModalVisible, setIsModalVisible] = useState(false);
                const [selectedSubmission, setSelectedSubmission] = useState(null);
                const [auditForm] = Form.useForm();

                const showAuditModal = record => {
                    setSelectedSubmission(record);
                    setIsModalVisible(true);
                };

                const handleAudit = () => {
                    auditForm.validateFields().then(values => {
                        const { status, comments } = values;
                        setBusinessData(currentData =>
                            currentData.map(d =>
                                d.id === selectedSubmission.id ? { ...d, status, auditComments: comments } : d
                            )
                        );
                        message.success('审核完成');
                        setIsModalVisible(false);
                    });
                };

                const getStatusTag = status => {
                    if (status === '已审核') return <Tag color="success">已审核</Tag>;
                    if (status === '待审核') return <Tag color="warning">待审核</Tag>;
                    if (status === '已驳回') return <Tag color="error">已驳回</Tag>;
                    return <Tag>{status}</Tag>;
                };

                const columns = [
                    { title: '填报年度', dataIndex: 'year', key: 'year' },
                    { title: '企业名称', dataIndex: 'company', key: 'company' },
                    { title: '提交时间', dataIndex: 'submissionTime', key: 'submissionTime' },
                    { title: '状态', dataIndex: 'status', key: 'status', render: getStatusTag },
                    {
                        title: '操作',
                        key: 'action',
                        render: (_, record) => (
                            <Button type="primary" onClick={() => showAuditModal(record)}>
                                审核
                            </Button>
                        ),
                    },
                ];

                return (
                    <Card title="经营情况审核">
                        <Table columns={columns} dataSource={businessData} rowKey="id" />
                        <Modal
                            title="年度经营情况审核"
                            open={isModalVisible}
                            onCancel={() => setIsModalVisible(false)}
                            width={800}
                            onOk={handleAudit}
                            okText="提交审核"
                            cancelText="取消"
                        >
                            {selectedSubmission && (
                                <Form form={auditForm} layout="vertical">
                                    <Descriptions bordered column={1} size="small">
                                        <Descriptions.Item label="企业名称">
                                            {selectedSubmission.company}
                                        </Descriptions.Item>
                                        <Descriptions.Item label="填报年度">
                                            {selectedSubmission.year}
                                        </Descriptions.Item>
                                        <Descriptions.Item label="营收">
                                            {selectedSubmission.revenue.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedSubmission.revenue.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="税收">
                                            {selectedSubmission.tax.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedSubmission.tax.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="固投">
                                            {selectedSubmission.fixedInvestment.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedSubmission.fixedInvestment.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="产值">
                                            {selectedSubmission.outputValue.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedSubmission.outputValue.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                        <Descriptions.Item label="研发投入">
                                            {selectedSubmission.rdInvestment.value?.toLocaleString()} 元{' '}
                                            <Upload
                                                fileList={selectedSubmission.rdInvestment.files}
                                                disabled
                                                itemRender={(origin, file) => <a href="#">{file.name}</a>}
                                            />
                                        </Descriptions.Item>
                                    </Descriptions>
                                    <Divider>拟兑现政策计划</Divider>
                                    <Table
                                        size="small"
                                        pagination={false}
                                        dataSource={selectedSubmission.policyPlans}
                                        columns={[
                                            { title: '政策名称', dataIndex: 'policyName' },
                                            {
                                                title: '拟兑现金额(元)',
                                                dataIndex: 'budget',
                                                render: val => val?.toLocaleString(),
                                            },
                                        ]}
                                    />
                                    <Divider>审核操作</Divider>
                                    <Form.Item name="status" label="审核结果" rules={[{ required: true }]}>
                                        <Radio.Group>
                                            <Radio value="已审核">通过</Radio>
                                            <Radio value="已驳回">驳回</Radio>
                                        </Radio.Group>
                                    </Form.Item>
                                    <Form.Item name="comments" label="审核意见">
                                        <Input.TextArea rows={3} />
                                    </Form.Item>
                                </Form>
                            )}
                        </Modal>
                    </Card>
                );
            };

            const App = () => {
                const [activeGovTab, setActiveGovTab] = useState('2');

                const handleGovTabChange = key => {
                    setActiveGovTab(key);
                };

                const govItems = [
                    { key: '2', label: '项目列表', children: <GovernmentProjectManagement /> },
                    { key: '3', label: '履约节点跟踪看板', children: <KanbanBoard /> },
                    { key: '4', label: '履约情况审核中心', children: <AuditCenter /> },
                    { key: '6', label: '经营情况审核', children: <BusinessDataAuditCenter /> },
                    {
                        key: '0',
                        label: '履约全景看板',
                        children: <PanoramicDashboard setActiveTab={handleGovTabChange} />,
                    },
                    { key: '5', label: '协议跟踪报表', children: <TrackingReport /> },
                    { key: '1', label: '协议指标管理', children: <IndicatorManagement /> },
                ];

                return (
                    <Layout style={{ minHeight: '100vh' }}>
                        <Layout.Header
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                color: 'white',
                            }}
                        >
                            <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>一企一策全生命周期管理平台</div>
                            <div>
                                <Badge count={1}>
                                    <BellOutlined style={{ fontSize: '1.2em', cursor: 'pointer' }} />
                                </Badge>
                                <span style={{ marginLeft: 24 }}>欢迎您, 管理员</span>
                            </div>
                        </Layout.Header>
                        <Layout.Content style={{ padding: '24px' }}>
                            <Tabs
                                defaultActiveKey="gov"
                                animated={false}
                                items={[
                                    {
                                        label: `政务端`,
                                        key: 'gov',
                                        children: (
                                            <Tabs
                                                activeKey={activeGovTab}
                                                onChange={handleGovTabChange}
                                                items={govItems}
                                                tabPosition="left"
                                                animated={false}
                                            />
                                        ),
                                    },
                                    {
                                        label: `企业端`,
                                        key: 'enterprise',
                                        children: <EnterprisePage />,
                                    },
                                ]}
                            />
                        </Layout.Content>
                    </Layout>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        </script>
    </body>
</html>
